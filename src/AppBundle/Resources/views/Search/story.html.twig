{% extends 'AppBundle::layout.html.twig' %}


{% block body %}

<script src="/bundles/app/js/ui.stories.js"></script>

<style>
    #show-permanent-btn.active { background-color: #2f3542; color: #fff; border-color: #2f3542; }
    .fm-badge { background: #d0eaff; color: #000; padding: 2px 6px; border-radius: 4px; font-weight: 700; font-size:0.78rem; vertical-align: middle; margin-left:8px; display:inline-block; }
    .creator-badge { background: #000; color: #fff; padding: 2px 6px; border-radius: 4px; font-weight: 700; font-size:0.78rem; vertical-align: middle; margin-left:8px; display:inline-block; }
    .story-type-counter.no-match { border: 2px solid #d9534f; background: #fff5f5; color: #a94442; }
</style>

{% set show_spoilers = true %}
<div style="margin-left:200px; margin-right:200px;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px;">
        <h1 style="margin:0;">Stories</h1>
        <div>
            <button id="stories-back-btn" type="button" class="btn btn-sm btn-secondary" style="display:none;" onclick="history.back();">back</button>
            <script>
                (function(){
                    try {
                        var ref = document.referrer || '';
                        var qs = window.location.search || '';
                        var fromParam = /from_campaign=1|from_scenario=1|from_team=1/.test(qs);
                        // show back button when referrer looks like a team/campaign/scenario page or when explicit param present
                        if (fromParam) {
                            var btn = document.getElementById('stories-back-btn'); if (btn) btn.style.display = '';
                                try { var spb = document.getElementById('show-permanent-banner'); if (spb) spb.style.display = 'none'; } catch(e){}
                        } else if (ref && (ref.indexOf('/campaign') !== -1 || ref.indexOf('/scenario') !== -1 || ref.indexOf('/team/') !== -1)) {
                            var btn2 = document.getElementById('stories-back-btn'); if (btn2) btn2.style.display = '';
                                try { var spb2 = document.getElementById('show-permanent-banner'); if (spb2) spb2.style.display = 'none'; } catch(e){}
                        }
                    } catch(e){}
                })();
            </script>
        </div>
    </div>

    {# Utilise les variables combinées passées par le contrôleur #}
    <div style="margin-bottom: 24px;">
        {# expose all modular codes in a data attribute so the client can request global combined stats #}
        {% set _modcodes = '' %}
        {% if filtered_modular_sets is defined and filtered_modular_sets|length > 0 %}
            {% for s in filtered_modular_sets %}
                {% if loop.first %}{% set _modcodes = s.code %}{% else %}{% set _modcodes = _modcodes ~ ',' ~ s.code %}{% endif %}
            {% endfor %}
        {% endif %}
        {# debug attributes: server-side rendered selected villain code and scenario default for quick inspection #}
        {% set debug_vcode = selected_villain_code is defined ? selected_villain_code : '' %}
        {% set debug_default_val = (default_modulars_map[debug_vcode|lower] is defined) ? default_modulars_map[debug_vcode|lower] : '' %}
        {# determine if the page was invoked by campaign/scenario/team or explicit modular params #}
        {% set caller_provided_slots = (app.request.query.get('from_campaign') is not null and app.request.query.get('from_campaign') == '1') or (app.request.query.get('from_scenario') is not null and app.request.query.get('from_scenario') == '1') or (app.request.query.get('from_team') is not null and app.request.query.get('from_team') == '1') or (app.request.query.get('modulars') is not null) or (app.request.query.get('nbmodular') is not null) or (app.request.query.get('modular_set') is not null) %}
        <div id="combined-stats-panel" data-modular-codes="{{ _modcodes }}" data-default-modulars="{{ default_modulars_map|default({})|json_encode|e('html_attr') }}" data-caller-provided="{{ caller_provided_slots ? '1' : '0' }}">
            {% include 'AppBundle:Search:set_stats.html.twig' with {
                stats: combined_stats,
                color: '#111',
                label: 'Statistiques combinées des sets sélectionnés :',
                type_counts: combined_type_counts,
                boost_counts: combined_boost_counts,
                traits: combined_traits,
                set_name: combined_set_name
            } %}
        </div>
    </div>

    {# server-side: allow campaign/scenario/team or caller-provided modular params to signal we should hide randomize via query param for robust behavior #}
        {% if hide_randomize is not defined %}
            {% set hide_randomize = caller_provided_slots or (app.request.query.get('from_campaign') is not null and app.request.query.get('from_campaign') == '1') or (app.request.query.get('from_scenario') is not null and app.request.query.get('from_scenario') == '1') or (app.request.query.get('from_team') is not null and app.request.query.get('from_team') == '1') %}
        {% endif %}
    <div style="margin-bottom:12px;">
        <div id="randomize-banner" class="story-banner" style="display:{{ hide_randomize ? 'none' : 'flex' }}; align-items:center; justify-content:flex-start; background:#f5f7fa; padding:8px 12px; border-radius:6px; gap:12px;">
            <div>
                <button id="randomize-btn" type="button" class="btn btn-sm btn-outline-secondary" style="padding:6px 10px;">Randomize</button>
                <button id="randomize-modulars-btn" type="button" class="btn btn-sm btn-outline-secondary" style="padding:6px 10px; margin-left:8px;">Randomize modulars</button>
            </div>
            <div style="display:flex; align-items:center; gap:12px;">
                <div style="display:flex; align-items:center; gap:8px;">
                    <input id="randomize-exclude-std-exp" type="checkbox" checked />
                    <label for="randomize-exclude-std-exp" style="margin:0; font-size:0.95rem; color:#333;">Exclude Standard/Expert</label>
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                    <input id="randomize-exclude-fm-villain" type="checkbox" checked />
                    <label for="randomize-exclude-fm-villain" style="margin:0; font-size:0.95rem; color:#333;">Exclude Fanmade Villain</label>
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                    <input id="randomize-exclude-fm-modular" type="checkbox" checked />
                    <label for="randomize-exclude-fm-modular" style="margin:0; font-size:0.95rem; color:#333;">Exclude Fanmade Modulars</label>
                </div>
            </div>
        </div>
    </div>
    <script>
        (function(){
            try {
                // JS fallback: hide banner when referrer looks like campaign/scenario/team (covers cases without query param)
                var ref = document.referrer || '';
                var banner = document.getElementById('randomize-banner');
                if (banner && ref && (ref.indexOf('/campaign') !== -1 || ref.indexOf('/scenario') !== -1 || ref.indexOf('/team/') !== -1)) {
                    banner.style.display = 'none';
                }
            } catch(e){}
        })();
    </script>

    <div style="display: flex; align-items: flex-start; gap: 32px; margin-bottom: 18px;">
        <div>
            <div style="font-weight:bold; margin-bottom:6px;">Villain</div>
            <div style="display:flex; align-items:center; gap:8px;">
                <select id="villain-sets" name="villain_set" style="width: 100%;">
                {% for set in filtered_villain_sets %}
                    {% if villain_fanmade_map is defined and (villain_fanmade_map[set.code] is defined) %}
                        {% set is_fm = villain_fanmade_map[set.code] %}
                        {% else %}
                        {% set is_fm = (set.pack is defined and set.pack.creator is defined and (set.pack.creator is not empty and set.pack.creator is not null and set.pack.creator|lower != 'ffg')) ? 1 : 0 %}
                    {% endif %}
                    <option value="{{ set.code }}" data-fanmade="{{ is_fm }}" data-creator="{{ set.pack.creator|default('') }}"
                        {% if set.code == selected_villain_code %}selected{% endif %}>
                        {{ set.name }}
                    </option>
                {% endfor %}
                </select>
                <span id="badge-villain-sets" class="fm-badge" style="display:none;">FM</span>
                <span id="badge-villain-creator" class="creator-badge" style="display:none;">FFG</span>
            </div>
                {# Show Permanent button moved into the banner above the tabs #}
        </div>
        <div>
            <div style="font-weight:bold; margin-bottom:6px;">Modular slots</div>
            {# number of slots: prefer query param 'modulars' sent by campaign page, otherwise use scenario default or default to 1 #}
            {% set requested_slots = app.request.query.get('modulars') %}
            {% set max_slots = (filtered_modular_sets is defined) ? filtered_modular_sets|length : 0 %}
            {# Controller can supply an explicit `slots` variable when appropriate (e.g. TeamController). #}
            {% if slots is defined %}
                {# use controller-provided initial slots #}
                {% set slots = slots %}
            {% elseif requested_slots is not null and (requested_slots + 0) > 0 %}
                {% set slots = (requested_slots + 0) %}
            {% else %}
                {# default: prefer scenario-provided default modular count for selected villain, otherwise 1 #}
                {% set default_mod_map = default_modulars_map|default({}) %}
                {% set vcode = selected_villain_code is defined ? (selected_villain_code|lower) : '' %}
                {% set slots = (default_mod_map[vcode] is defined and default_mod_map[vcode]) ? (default_mod_map[vcode] + 0) : 1 %}
            {% endif %}
            {% if max_slots > 0 and slots > max_slots %}
                {% set slots = max_slots %}
            {% endif %}
                    {% if slots > 0 %}
                <div style="margin-top:6px; margin-bottom:12px; display:flex; gap:8px; align-items:center;">
                    <div style="display:flex; flex-direction:column;"><label style="font-weight:600;">Number of modulars</label>
                        <input id="num-modulars" type="number" min="1" max="{{ filtered_modular_sets|length }}" value="{{ slots }}" data-default-slots="{{ slots }}" style="width:100px; padding:4px;" />
                    </div>
                    <div style="display:flex; flex-direction:column; color:#666; font-size:0.95rem;">
                    </div>
                </div>
                {# render all available modular selects but mark them with data-index so JS can show/hide per requested count #}
                {% set selected_modular_codes = selected_modular_codes|default([]) %}
                {% for i in 0..(filtered_modular_sets|length - 1) %}
                    <div style="margin-bottom:6px;" class="modular-select" data-index="{{ i }}">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <select id="modular-sets-{{ i }}" name="modular_set_{{ i }}" style="width: 100%;">
                            {% set current_selected = selected_modular_codes[i] is defined ? selected_modular_codes[i] : null %}
                            {% for set in filtered_modular_sets %}
                                {% if modular_fanmade_map is defined and (modular_fanmade_map[set.code] is defined) %}
                                    {% set is_fm = modular_fanmade_map[set.code] %}
                                {% else %}
                                    {% set is_fm = (set.pack is defined and set.pack.creator is defined and (set.pack.creator is not empty and set.pack.creator is not null and set.pack.creator|lower != 'ffg')) ? 1 : 0 %}
                                {% endif %}
                                {% set mc_minion = modular_set_type_counts[set.code]['Minion']|default(0) %}
                                {% set mc_treachery = modular_set_type_counts[set.code]['Treachery']|default(0) %}
                                {% set mc_attachment = modular_set_type_counts[set.code]['Attachment']|default(0) %}
                                {% set mc_environment = modular_set_type_counts[set.code]['Environment']|default(0) %}
                                {% set mc_sidescheme = modular_set_type_counts[set.code]['Side Scheme']|default(0) %}
                                {% if current_selected is not null %}
                                    <option value="{{ set.code }}" data-fanmade="{{ is_fm }}" data-creator="{{ set.pack.creator|default('') }}" data-count-minion="{{ mc_minion }}" data-count-treachery="{{ mc_treachery }}" data-count-attachment="{{ mc_attachment }}" data-count-environment="{{ mc_environment }}" data-count-side-scheme="{{ mc_sidescheme }}" {% if set.code == current_selected %}selected{% endif %}>{{ set.name }}</option>
                                {% else %}
                                    <option value="{{ set.code }}" data-fanmade="{{ is_fm }}" data-creator="{{ set.pack.creator|default('') }}" data-count-minion="{{ mc_minion }}" data-count-treachery="{{ mc_treachery }}" data-count-attachment="{{ mc_attachment }}" data-count-environment="{{ mc_environment }}" data-count-side-scheme="{{ mc_sidescheme }}" {% if set.code == filtered_modular_sets[i].code %}selected{% endif %}>{{ set.name }}</option>
                                {% endif %}
                            {% endfor %}
                            </select>
                            <span id="badge-modular-sets-{{ i }}" class="fm-badge" style="display:none;">FM</span>
                            <span id="badge-modular-creator-{{ i }}" class="creator-badge" style="display:none;">FFG</span>
                        </div>
                    </div>
                {% endfor %}
                <div id="modulars-warning" style="display:none; color:#d9534f; font-weight:600; margin-top:8px;">Not enough modulars available to satisfy filters</div>
                <script>
                    (function(){
                        try {
                            var ref = document.referrer || '';
                            if (ref && (ref.indexOf('/campaign') !== -1 || ref.indexOf('/scenario') !== -1 || ref.indexOf('/team/') !== -1)) {
                                var spb = document.getElementById('show-permanent-banner'); if (spb) spb.style.display = 'none';
                            }
                        } catch(e){}
                    })();
                </script>
            {% else %}
                <div style="color:#777;">No modular sets available</div>
            {% endif %}
        </div>
        <div>
            <div style="font-weight:bold; margin-bottom:6px;">Standard modular</div>
            <div style="display:flex; align-items:center; gap:8px;">
                <select id="standard-sets" name="standard_set" style="width: 100%;">
                <option value="" {% if selected_standard_code is empty %}selected{% endif %}>none</option>
                {% if filtered_standard_sets is defined and filtered_standard_sets|length > 0 %}
                    {% for set in filtered_standard_sets %}
                        {% if standard_fanmade_map is defined and (standard_fanmade_map[set.code] is defined) %}
                            {% set is_fm = standard_fanmade_map[set.code] %}
                        {% else %}
                            {% set is_fm = (set.pack is defined and set.pack.creator is defined and (set.pack.creator is not empty and set.pack.creator is not null and set.pack.creator|lower != 'ffg')) ? 1 : 0 %}
                        {% endif %}
                        <option value="{{ set.code }}" data-fanmade="{{ is_fm }}" data-creator="{{ set.pack.creator|default('') }}" {% if set.code == selected_standard_code %}selected{% endif %}>{{ set.name }}</option>
                    {% endfor %}
                {% else %}
                    <option value="">No standard sets</option>
                {% endif %}
                </select>
                <span id="badge-standard-sets" class="fm-badge" style="display:none;">FM</span>
                <span id="badge-standard-creator" class="creator-badge" style="display:none;">FFG</span>
            </div>
            <div style="height:6px;"></div>
            <div style="font-weight:bold; margin-bottom:6px;">Expert modular</div>
            <div style="display:flex; align-items:center; gap:8px;">
                <select id="expert-sets" name="expert_set" style="width: 100%;">
                <option value="" {% if selected_expert_code is empty %}selected{% endif %}>none</option>
                {% if filtered_expert_sets is defined and filtered_expert_sets|length > 0 %}
                    {% for set in filtered_expert_sets %}
                        {% if expert_fanmade_map is defined and (expert_fanmade_map[set.code] is defined) %}
                            {% set is_fm = expert_fanmade_map[set.code] %}
                        {% else %}
                            {% set is_fm = (set.pack is defined and set.pack.creator is defined and (set.pack.creator is not empty and set.pack.creator is not null and set.pack.creator|lower != 'ffg')) ? 1 : 0 %}
                        {% endif %}
                        <option value="{{ set.code }}" data-fanmade="{{ is_fm }}" data-creator="{{ set.pack.creator|default('') }}" {% if set.code == selected_expert_code %}selected{% endif %}>{{ set.name }}</option>
                    {% endfor %}
                {% else %}
                    <option value="">No expert sets</option>
                {% endif %}
                </select>
                <span id="badge-expert-sets" class="fm-badge" style="display:none;">FM</span>
                <span id="badge-expert-creator" class="creator-badge" style="display:none;">FFG</span>
            </div>
            
        </div>
    </div>

    <div style="margin-top: 32px;">
        <div id="show-permanent-banner" class="story-banner" style="display:{{ hide_randomize ? 'none' : 'flex' }}; align-items:center; justify-content:flex-start; background:#f5f7fa; padding:8px 12px; border-radius:6px; margin-bottom:12px; gap:16px;">
                <div>
                    <button id="show-permanent-btn" type="button" class="btn btn-sm btn-outline-secondary" data-show="1" style="padding:6px 10px;">Show Permanent</button>
                </div>
                <div id="modulars-minimum-label" style="font-weight:600; color:#333; margin-left:8px;">Modulars' minimum</div>
                <div id="story-filter-counters" style="display:flex; align-items:center; gap:12px;">
                    <div style="display:flex; align-items:center; gap:6px; font-weight:600; color:#333;">
                        <i class="fas fa-dragon" style="margin-right:4px;"></i>
                        <span style="font-size:0.92rem;">Minion</span>
                        <input class="story-type-counter" data-type="minion" type="number" min="0" value="0" style="width:64px; padding:4px;" />
                    </div>
                    <div style="display:flex; align-items:center; gap:6px; font-weight:600; color:#333;">
                        <i class="fas fa-skull-crossbones" style="margin-right:4px;"></i>
                        <span style="font-size:0.92rem;">Treachery</span>
                        <input class="story-type-counter" data-type="treachery" type="number" min="0" value="0" style="width:64px; padding:4px;" />
                    </div>
                    <div style="display:flex; align-items:center; gap:6px; font-weight:600; color:#333;">
                        <i class="fas fa-paperclip" style="margin-right:4px;"></i>
                        <span style="font-size:0.92rem;">Attachment</span>
                        <input class="story-type-counter" data-type="attachment" type="number" min="0" value="0" style="width:64px; padding:4px;" />
                    </div>
                    <div style="display:flex; align-items:center; gap:6px; font-weight:600; color:#333;">
                        <i class="fas fa-tree" style="margin-right:4px;"></i>
                        <span style="font-size:0.92rem;">Environment</span>
                        <input class="story-type-counter" data-type="environment" type="number" min="0" value="0" style="width:64px; padding:4px;" />
                    </div>
                    <div style="display:flex; align-items:center; gap:6px; font-weight:600; color:#333;">
                        <i class="fas fa-project-diagram" style="margin-right:4px;"></i>
                        <span style="font-size:0.92rem;">Side Scheme</span>
                        <input class="story-type-counter" data-type="side-scheme" type="number" min="0" value="0" style="width:64px; padding:4px;" />
                    </div>
                </div>
                <div style="margin-left:auto;">
                    <button id="clear-story-filters-btn" type="button" class="btn btn-sm btn-outline-secondary" style="padding:6px 10px;">Clear filters</button>
                </div>
            </div>
        <div style="display: flex; gap: 8px; align-items:center;">
            {% set current_villain_name = '' %}
            {% if filtered_villain_sets is defined %}
                {% for s in filtered_villain_sets %}
                    {% if s.code == selected_villain_code %}
                        {% set current_villain_name = s.name %}
                    {% endif %}
                {% endfor %}
            {% endif %}
            <button id="tab-villain" type="button" class="tab-btn"
                style="padding: 8px 14px; border-radius: 6px; border: none; background: #eee; color: #222; font-weight: bold; cursor:pointer;">
                {{ current_villain_name|default('Villain') }}
            </button>
            <button id="tab-standard" type="button" class="tab-btn"
                style="padding: 8px 14px; border-radius: 6px; border: none; background: #eee; color: #222; font-weight: bold; cursor:pointer;">
                Standard
            </button>
            <button id="tab-expert" type="button" class="tab-btn"
                style="padding: 8px 14px; border-radius: 6px; border: none; background: #eee; color: #222; font-weight: bold; cursor:pointer;">
                Expert
            </button>
            {# Global tab removed per request: aggregation handled via 'Modular' selects and default behavior #}
            {% for i in 0..(filtered_modular_sets|length - 1) %}
                {% set current_code = (selected_modular_codes[i] is defined and selected_modular_codes[i]) ? selected_modular_codes[i] : filtered_modular_sets[i].code %}
                {% set current_name = '' %}
                {% for s in filtered_modular_sets %}
                    {% if s.code == current_code %}
                        {% set current_name = s.name %}
                    {% endif %}
                {% endfor %}
                <button id="tab-modular-{{ i }}" type="button" class="tab-modular-btn tab-btn" data-index="{{ i }}"
                    style="padding: 8px 14px; border-radius: 6px; border: none; background: #eee; color: #222; font-weight: bold; cursor:pointer;">
                    {{ current_name|default('Modular ' ~ (i+1)) }}
                </button>
            {% endfor %}
        </div>

        <div id="tab-villain-content" style="display:block;">
            <div style="height:18px;"></div>
            {% if filtered_villain_sets|length > 0 %}
                {% for set in filtered_villain_sets %}
                    <div class="villain-cards-panel" id="villain-cards-{{ set.code }}" style="{% if set.code != selected_villain_code %}display:none;{% endif %}">
                        {% include 'AppBundle:Search:set_stats.html.twig' with {
                            stats: villain_set_stats[set.code],
                            color: '#445566ff',
                            label: 'Statistiques du set villain sélectionné :',
                            type_counts: villain_set_type_counts[set.code],
                            boost_counts: villain_set_boost_counts[set.code],
                            traits: villain_traits_by_set[set.code],
                            set_name: set.name
                        } %}
                        {% if villain_cards_by_set[set.code]|length > 0 %}
                            {% include 'AppBundle:Search:display-card-list.html.twig' with {
                                cards: villain_cards_by_set[set.code],
                                set: set
                            } %}
                        {% endif %}
                    </div>
                {% endfor %}
            {% endif %}
        </div>

        <div id="tab-standard-content" style="display:none;">
            <div style="height:18px;"></div>
            {% if filtered_standard_sets|length > 0 %}
                {% for set in filtered_standard_sets %}
                    <div class="set-infos-panel" id="infos-standard-{{ set.code }}" style="{% if set.code != selected_standard_code %}display:none;{% endif %}">
                        {% include 'AppBundle:Search:set_stats.html.twig' with {
                            stats: standard_set_stats[set.code],
                            color: '#445566ff',
                            label: 'Statistiques du set standard sélectionné :',
                            type_counts: standard_set_type_counts[set.code],
                            boost_counts: standard_set_boost_counts[set.code],
                            traits: standard_traits_by_set[set.code],
                            set_name: set.name
                        } %}
                    </div>
                {% endfor %}
            {% endif %}
            <div>
                {% if filtered_standard_sets|length > 0 %}
                    {% for set in filtered_standard_sets %}
                        <div class="set-cards-panel" id="cards-standard-{{ set.code }}" style="{% if set.code != selected_standard_code %}display:none;{% endif %}">
                            {% if standard_cards_by_set[set.code]|length > 0 %}
                                {% include 'AppBundle:Search:display-card-list.html.twig' with {
                                    cards: standard_cards_by_set[set.code],
                                    set: set
                                } %}
                            {% endif %}
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>

        <div id="tab-expert-content" style="display:none;">
            <div style="height:18px;"></div>
            {% if filtered_expert_sets|length > 0 %}
                {% for set in filtered_expert_sets %}
                    <div class="set-infos-panel" id="infos-expert-{{ set.code }}" style="{% if set.code != selected_expert_code %}display:none;{% endif %}">
                        {% include 'AppBundle:Search:set_stats.html.twig' with {
                            stats: expert_set_stats[set.code],
                            color: '#445566ff',
                            label: 'Statistiques du set expert sélectionné :',
                            type_counts: expert_set_type_counts[set.code],
                            boost_counts: expert_set_boost_counts[set.code],
                            traits: expert_traits_by_set[set.code],
                            set_name: set.name
                        } %}
                    </div>
                {% endfor %}
            {% endif %}
            <div>
                {% if filtered_expert_sets|length > 0 %}
                    {% for set in filtered_expert_sets %}
                        <div class="set-cards-panel" id="cards-expert-{{ set.code }}" style="{% if set.code != selected_expert_code %}display:none;{% endif %}">
                            {% if expert_cards_by_set[set.code]|length > 0 %}
                                {% include 'AppBundle:Search:display-card-list.html.twig' with {
                                    cards: expert_cards_by_set[set.code],
                                    set: set
                                } %}
                            {% endif %}
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>

        <div id="tab-modular-content" style="display:none;">
            <div style="height:18px;"></div>
            {% if filtered_modular_sets|length > 0 %}
                {% for set in filtered_modular_sets %}
                    <div class="set-infos-panel" id="infos-modular-{{ set.code }}" style="{% if set.code != selected_modular_code %}display:none;{% endif %}">
                        {% include 'AppBundle:Search:set_stats.html.twig' with {
                            stats: modular_set_stats[set.code],
                            color: '#445566ff',
                            label: 'Statistiques du set modular sélectionné :',
                            type_counts: modular_set_type_counts[set.code],
                            boost_counts: modular_set_boost_counts[set.code],
                            traits: modular_traits_by_set[set.code],
                            set_name: set.name
                        } %}
                    </div>
                {% endfor %}
            {% endif %}
            <div>
                {% if filtered_modular_sets|length > 0 %}
                    {% for set in filtered_modular_sets %}
                        <div class="set-cards-panel" id="cards-modular-{{ set.code }}" style="{% if set.code != selected_modular_code %}display:none;{% endif %}">
                            {% if modular_cards_by_set[set.code]|length > 0 %}
                                {% include 'AppBundle:Search:display-card-list.html.twig' with {
                                    cards: modular_cards_by_set[set.code],
                                    set: set
                                } %}
                            {% endif %}
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}
