{% extends 'AppBundle::layout.html.twig' %}


{% block body %}

<script src="/bundles/app/js/ui.stories.js"></script>

<style>
    #show-permanent-btn.active { background-color: #2f3542; color: #fff; border-color: #2f3542; }
</style>

{% set show_spoilers = true %}
<div style="margin-left:200px; margin-right:200px;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px;">
        <h1 style="margin:0;">Stories</h1>
        <div>
            <button id="stories-back-btn" type="button" class="btn btn-sm btn-secondary" style="display:none;" onclick="history.back();">back</button>
            <script>
                (function(){
                    try {
                        var ref = document.referrer || '';
                        if (ref && (ref.indexOf('/view/') !== -1 || ref.indexOf('/edit/') !== -1 || ref.indexOf('/campaign/') !== -1)) {
                            var btn = document.getElementById('stories-back-btn');
                            if (btn) btn.style.display = '';
                        }
                    } catch(e){}
                })();
            </script>
        </div>
    </div>

    {# Utilise les variables combinées passées par le contrôleur #}
    <div style="margin-bottom: 24px;">
        {# expose all modular codes in a data attribute so the client can request global combined stats #}
        {% set _modcodes = '' %}
        {% if filtered_modular_sets is defined and filtered_modular_sets|length > 0 %}
            {% for s in filtered_modular_sets %}
                {% if loop.first %}{% set _modcodes = s.code %}{% else %}{% set _modcodes = _modcodes ~ ',' ~ s.code %}{% endif %}
            {% endfor %}
        {% endif %}
        <div id="combined-stats-panel" data-modular-codes="{{ _modcodes }}">
            {% include 'AppBundle:Search:set_stats.html.twig' with {
                stats: combined_stats,
                color: '#111',
                label: 'Statistiques combinées des sets sélectionnés :',
                type_counts: combined_type_counts,
                boost_counts: combined_boost_counts,
                traits: combined_traits,
                set_name: combined_set_name
            } %}
        </div>
    </div>

    <div style="display: flex; align-items: flex-start; gap: 32px; margin-bottom: 18px;">
        <div>
            <div style="font-weight:bold; margin-bottom:6px;">Villain</div>
            <select id="villain-sets" name="villain_set" style="width: 100%;">
                {% for set in filtered_villain_sets %}
                    <option value="{{ set.code }}"
                        {% if set.code == selected_villain_code %}selected{% endif %}>
                        {{ set.name }}
                    </option>
                {% endfor %}
            </select>
                {# Show Permanent button moved into the banner above the tabs #}
        </div>
        <div>
            <div style="font-weight:bold; margin-bottom:6px;">Modular slots</div>
            {# number of slots: prefer query param 'modulars' sent by campaign page, otherwise default to 1 #}
            {% set requested_slots = app.request.query.get('modulars') %}
            {% set max_slots = (filtered_modular_sets is defined) ? filtered_modular_sets|length : 0 %}
            {# Controller can supply an explicit `slots` variable when appropriate (e.g. TeamController). #}
            {% if slots is defined %}
                {# use controller-provided initial slots #}
                {% set slots = slots %}
            {% elseif requested_slots is not null and (requested_slots + 0) > 0 %}
                {% set slots = (requested_slots + 0) %}
            {% else %}
                {# default to 1 when opened directly without explicit param or controller hint #}
                {% set slots = 1 %}
            {% endif %}
            {% if max_slots > 0 and slots > max_slots %}
                {% set slots = max_slots %}
            {% endif %}
            {% if slots > 0 %}
                <div style="margin-top:6px; margin-bottom:12px; display:flex; gap:8px; align-items:center;">
                    <div style="display:flex; flex-direction:column;"><label style="font-weight:600;">Number of modulars</label>
                        <input id="num-modulars" type="number" min="1" max="{{ filtered_modular_sets|length }}" value="{{ slots }}" style="width:100px; padding:4px;" />
                    </div>
                    <div style="color:#666; font-size:0.95rem;">Value passed by the campaign page if provided, otherwise default.</div>
                </div>
                {# render all available modular selects but mark them with data-index so JS can show/hide per requested count #}
                {% for i in 0..(filtered_modular_sets|length - 1) %}
                    <div style="margin-bottom:6px;" class="modular-select" data-index="{{ i }}">
                        <select id="modular-sets-{{ i }}" name="modular_set_{{ i }}" style="width: 100%;">
                            {% for set in filtered_modular_sets %}
                                <option value="{{ set.code }}" {% if set.code == (filtered_modular_sets[i].code) %}selected{% endif %}>{{ set.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                {% endfor %}
            {% else %}
                <div style="color:#777;">No modular sets available</div>
            {% endif %}
        </div>
        <div>
            <div style="font-weight:bold; margin-bottom:6px;">Standard modular</div>
            <select id="standard-sets" name="standard_set" style="width: 100%;">
                <option value="" {% if selected_standard_code is empty %}selected{% endif %}>none</option>
                {% if filtered_standard_sets is defined and filtered_standard_sets|length > 0 %}
                    {% for set in filtered_standard_sets %}
                        <option value="{{ set.code }}" {% if set.code == selected_standard_code %}selected{% endif %}>{{ set.name }}</option>
                    {% endfor %}
                {% else %}
                    <option value="">No standard sets</option>
                {% endif %}
            </select>
            <div style="height:6px;"></div>
            <div style="font-weight:bold; margin-bottom:6px;">Expert modular</div>
            <select id="expert-sets" name="expert_set" style="width: 100%;">
                <option value="" {% if selected_expert_code is empty %}selected{% endif %}>none</option>
                {% if filtered_expert_sets is defined and filtered_expert_sets|length > 0 %}
                    {% for set in filtered_expert_sets %}
                        <option value="{{ set.code }}" {% if set.code == selected_expert_code %}selected{% endif %}>{{ set.name }}</option>
                    {% endfor %}
                {% else %}
                    <option value="">No expert sets</option>
                {% endif %}
            </select>
            
        </div>
    </div>

    <div style="margin-top: 32px;">
        <div class="story-banner" style="display:flex; align-items:center; justify-content:flex-start; background:#f5f7fa; padding:8px 12px; border-radius:6px; margin-bottom:12px;">
            <div>
                <button id="show-permanent-btn" type="button" class="btn btn-sm btn-outline-secondary" data-show="1" style="padding:6px 10px;">Show Permanent</button>
            </div>
        </div>
        <div style="display: flex; gap: 8px; align-items:center;">
            <button id="tab-villain" type="button" class="tab-btn"
                style="padding: 8px 14px; border-radius: 6px; border: none; background: #eee; color: #222; font-weight: bold; cursor:pointer;">
                Villain
            </button>
            <button id="tab-standard" type="button" class="tab-btn"
                style="padding: 8px 14px; border-radius: 6px; border: none; background: #eee; color: #222; font-weight: bold; cursor:pointer;">
                Standard
            </button>
            <button id="tab-expert" type="button" class="tab-btn"
                style="padding: 8px 14px; border-radius: 6px; border: none; background: #eee; color: #222; font-weight: bold; cursor:pointer;">
                Expert
            </button>
            {# Global tab removed per request: aggregation handled via 'Modular' selects and default behavior #}
            {% for i in 0..(filtered_modular_sets|length - 1) %}
                <button id="tab-modular-{{ i }}" type="button" class="tab-modular-btn tab-btn" data-index="{{ i }}"
                    style="padding: 8px 14px; border-radius: 6px; border: none; background: #eee; color: #222; font-weight: bold; cursor:pointer;">
                    Modular {{ i+1 }}
                </button>
            {% endfor %}
        </div>

        <div id="tab-villain-content" style="display:block;">
            <div style="height:18px;"></div>
            {% if filtered_villain_sets|length > 0 %}
                {% for set in filtered_villain_sets %}
                    <div class="villain-cards-panel" id="villain-cards-{{ set.code }}" style="{% if set.code != selected_villain_code %}display:none;{% endif %}">
                        {% include 'AppBundle:Search:set_stats.html.twig' with {
                            stats: villain_set_stats[set.code],
                            color: '#445566ff',
                            label: 'Statistiques du set villain sélectionné :',
                            type_counts: villain_set_type_counts[set.code],
                            boost_counts: villain_set_boost_counts[set.code],
                            traits: villain_traits_by_set[set.code],
                            set_name: set.name
                        } %}
                        {% if villain_cards_by_set[set.code]|length > 0 %}
                            {% include 'AppBundle:Search:display-card-list.html.twig' with {
                                cards: villain_cards_by_set[set.code],
                                set: set
                            } %}
                        {% endif %}
                    </div>
                {% endfor %}
            {% endif %}
        </div>

        <div id="tab-standard-content" style="display:none;">
            <div style="height:18px;"></div>
            {% if filtered_standard_sets|length > 0 %}
                {% for set in filtered_standard_sets %}
                    <div class="set-infos-panel" id="infos-standard-{{ set.code }}" style="{% if set.code != selected_standard_code %}display:none;{% endif %}">
                        {% include 'AppBundle:Search:set_stats.html.twig' with {
                            stats: standard_set_stats[set.code],
                            color: '#445566ff',
                            label: 'Statistiques du set standard sélectionné :',
                            type_counts: standard_set_type_counts[set.code],
                            boost_counts: standard_set_boost_counts[set.code],
                            traits: standard_traits_by_set[set.code],
                            set_name: set.name
                        } %}
                    </div>
                {% endfor %}
            {% endif %}
            <div>
                {% if filtered_standard_sets|length > 0 %}
                    {% for set in filtered_standard_sets %}
                        <div class="set-cards-panel" id="cards-standard-{{ set.code }}" style="{% if set.code != selected_standard_code %}display:none;{% endif %}">
                            {% if standard_cards_by_set[set.code]|length > 0 %}
                                {% include 'AppBundle:Search:display-card-list.html.twig' with {
                                    cards: standard_cards_by_set[set.code],
                                    set: set
                                } %}
                            {% endif %}
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>

        <div id="tab-expert-content" style="display:none;">
            <div style="height:18px;"></div>
            {% if filtered_expert_sets|length > 0 %}
                {% for set in filtered_expert_sets %}
                    <div class="set-infos-panel" id="infos-expert-{{ set.code }}" style="{% if set.code != selected_expert_code %}display:none;{% endif %}">
                        {% include 'AppBundle:Search:set_stats.html.twig' with {
                            stats: expert_set_stats[set.code],
                            color: '#445566ff',
                            label: 'Statistiques du set expert sélectionné :',
                            type_counts: expert_set_type_counts[set.code],
                            boost_counts: expert_set_boost_counts[set.code],
                            traits: expert_traits_by_set[set.code],
                            set_name: set.name
                        } %}
                    </div>
                {% endfor %}
            {% endif %}
            <div>
                {% if filtered_expert_sets|length > 0 %}
                    {% for set in filtered_expert_sets %}
                        <div class="set-cards-panel" id="cards-expert-{{ set.code }}" style="{% if set.code != selected_expert_code %}display:none;{% endif %}">
                            {% if expert_cards_by_set[set.code]|length > 0 %}
                                {% include 'AppBundle:Search:display-card-list.html.twig' with {
                                    cards: expert_cards_by_set[set.code],
                                    set: set
                                } %}
                            {% endif %}
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>

        <div id="tab-modular-content" style="display:none;">
            <div style="height:18px;"></div>
            {% if filtered_modular_sets|length > 0 %}
                {% for set in filtered_modular_sets %}
                    <div class="set-infos-panel" id="infos-modular-{{ set.code }}" style="{% if set.code != selected_modular_code %}display:none;{% endif %}">
                        {% include 'AppBundle:Search:set_stats.html.twig' with {
                            stats: modular_set_stats[set.code],
                            color: '#445566ff',
                            label: 'Statistiques du set modular sélectionné :',
                            type_counts: modular_set_type_counts[set.code],
                            boost_counts: modular_set_boost_counts[set.code],
                            traits: modular_traits_by_set[set.code],
                            set_name: set.name
                        } %}
                    </div>
                {% endfor %}
            {% endif %}
            <div>
                {% if filtered_modular_sets|length > 0 %}
                    {% for set in filtered_modular_sets %}
                        <div class="set-cards-panel" id="cards-modular-{{ set.code }}" style="{% if set.code != selected_modular_code %}display:none;{% endif %}">
                            {% if modular_cards_by_set[set.code]|length > 0 %}
                                {% include 'AppBundle:Search:display-card-list.html.twig' with {
                                    cards: modular_cards_by_set[set.code],
                                    set: set
                                } %}
                            {% endif %}
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}
