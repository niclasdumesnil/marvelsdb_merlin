{% macro pack_list(data, types, creator_labels, visibility) %}
    <ul class="pack-list">
        {% for type in types %}
            {% set first_pack = (data
                |filter(p => p.creator != 'FFG'
                    and (visibility is null or p.visibility == visibility)
                    and p.type == type
                )|first) %}
            <span class="pack-type-label">
                {% if first_pack is defined and first_pack %}
                    {{ first_pack.type_name }}
                {% endif %}
            </span>
            <br>
            {% set packs_of_type = data
                |filter(p => p.creator != 'FFG'
                    and (visibility is null or p.visibility == visibility)
                    and p.type == type
                )
                |sort((a, b) =>
                    a.creator|lower < b.creator|lower
                        ? -1
                        : (a.creator|lower > b.creator|lower
                            ? 1
                            : (a.name < b.name
                                ? -1
                                : (a.name > b.name ? 1 : 0)
                            )
                        )
                )
            %}
            {% set seen_creators = [] %}
            {% for pack in packs_of_type %}
                {% if pack.creator not in seen_creators %}
                    {% set seen_creators = seen_creators|merge([pack.creator]) %}
                    <li class="creator-li">
                        <div class="creator-box">
                            <ul class="creator-list">
                            {% for subpack in packs_of_type if subpack.creator == pack.creator %}
                                <li>
                                    &gt; <a title="{{ subpack.name }}" href="{{ subpack.url }}">{{ subpack.name }}</a>
                                    {% if subpack.status in ["alpha", "beta"] %}
                                        <span class="tag status-{{ subpack.status }}">{{ subpack.status ?? 'Official' }}</span>
                                    {% endif %}
                                    {# {% if subpack.status in ["released", "sealed"] %}
                                        <span class="tag status-{{ subpack.status }}">{{ subpack.status ?? 'Official' }}</span>
                                    {% endif %} #}
                                    {% if subpack.pack_type_code is defined and subpack.pack_type_code == 'hero_fanmade' %}
                                        <span class="tag custom-hero">Custom Hero Pack</span>
                                    {% endif %}
                                    {% if subpack.language is defined and subpack.language == "fr" %}
                                        <span class="tag french-only">French only</span>
                                    {% endif %}
                                    {% if subpack.creator is not defined or subpack.creator == "FFG" or subpack.creator == "" %}
                                        <span class="tag ffg">FFG</span>
                                    {% endif %}
                                </li>
                            {% endfor %}
                            </ul>
                            <div>
                                <span class="tag creator" style="margin-top: 0.5em; display: inline-block;">
                                    {{ creator_labels[pack.creator] ?? pack.creator }}
                                </span>
                            </div>
                        </div>
                    </li>
                {% endif %}
            {% endfor %}
        {% endfor %}
    </ul>
{% endmacro %}

{% import _self as macros %}

{% set creator_colors = {
    'default': 'rgb(18, 120, 216)',
    'createur1': 'rgb(158, 14, 187)',
    'createur2': 'rgb(3, 88, 84)'
} %}
{% set creator_labels = {
    'Merlin': 'Merlin',
    'Designhacker': 'Hax'
} %}

<ul class="nav nav-tabs" id="packsTabs" role="tablist" style="margin-bottom:1em;">
    <li class="nav-item" role="presentation">
        <a class="nav-link active" id="ffg-tab" data-toggle="tab" href="#ffg" role="tab" aria-controls="ffg" aria-selected="true">Current</a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link" id="fanmade-tab" data-toggle="tab" href="#fanmade" role="tab" aria-controls="fanmade" aria-selected="false">Fan made</a>
    </li>
    {% if app.user and app.user.donation == "1" %}
    <li class="nav-item" role="presentation">
        <a class="nav-link" id="private-tab" data-toggle="tab" href="#private" role="tab" aria-controls="private" aria-selected="false">Private</a>
    </li>
    {% endif %}
</ul>
<div class="tab-content" id="packsTabsContent">
    <div class="tab-pane fade show active" id="ffg" role="tabpanel" aria-labelledby="ffg-tab">
        <ol>
            <span style="display:inline-block; background:rgb(70, 68, 68); color:#fff; border-radius:6px; padding:2px 12px; margin:6px 0 6px 0; font-weight:semi;">FFG</span>
            {% for pack in data %}
                {% if pack.creator == 'FFG' %}
                    {% if pack.type == 'core' or pack.type == 'story' or pack.type =='encounter' %}
                        <li>
                            <a href="{{ pack.url }}">{{ pack.name }}</a>
                            <span>
                                {% if pack.available == false %}({{ pack.known }} cards){% endif %}
                            </span>
                        </li>
                    {% else %}
                        <li style="margin-left:2em;">
                            <a href="{{ pack.url }}">{{ pack.name }}</a>
                            <span>
                                {% if pack.available == false %}({{ pack.known }} cards){% endif %}
                            </span>
                        </li>
                    {% endif %}
                {% endif %}
            {% endfor %}
        </ol>
    </div>
    <div class="tab-pane fade" id="fanmade" role="tabpanel" aria-labelledby="fanmade-tab">
        {% set fan_types = [] %}
        {% for pack in data %}
            {% if pack.creator != 'FFG' and pack.visibility != "false" and (pack.type is not empty) and (pack.type not in fan_types) %}
                {% set fan_types = fan_types|merge([pack.type]) %}
            {% endif %}
        {% endfor %}
        {{ macros.pack_list(data, fan_types, creator_labels, "true") }}
    </div>
    {% if app.user and app.user.donation == "1" %}
    <div class="tab-pane fade" id="private" role="tabpanel" aria-labelledby="private-tab">
        {% set private_types = [] %}
        {% for pack in data %}
            {% if pack.creator != 'FFG' and pack.visibility == "false" and (pack.type is not empty) and (pack.type not in private_types) %}
                {% set private_types = private_types|merge([pack.type]) %}
            {% endif %}
        {% endfor %}
        {{ macros.pack_list(data, private_types, creator_labels, "false") }}
    </div>
    {% endif %}
</div>

<style>
.tab-pane {
  display: none;
}
.tab-pane.show.active {
  display: block !important;
  color: inherit !important;
  background: inherit !important;
  visibility: visible !important;
  opacity: 1 !important;
  z-index: auto !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Désactive tous les onglets et contenus
    document.querySelectorAll('.nav-link').forEach(function(t){
        t.classList.remove('active');
        t.setAttribute('aria-selected', 'false');
    });
    document.querySelectorAll('.tab-pane').forEach(function(p){
        p.classList.remove('show','active');
    });
    var ffgTab = document.getElementById('ffg-tab');
    var ffgPane = document.getElementById('ffg');
    if(ffgTab && ffgPane) {
        ffgTab.classList.add('active');
        ffgTab.setAttribute('aria-selected', 'true');
        ffgPane.classList.add('show','active');
    }

    // Gestion du clic sur les onglets
    document.querySelectorAll('.nav-link').forEach(function(tab) {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelectorAll('.nav-link').forEach(function(t){
                t.classList.remove('active');
                t.setAttribute('aria-selected', 'false');
            });
            tab.classList.add('active');
            tab.setAttribute('aria-selected', 'true');
            document.querySelectorAll('.tab-pane').forEach(function(p){
                p.classList.remove('show','active');
            });
            var pane = document.querySelector(tab.getAttribute('href'));
            if(pane) {
                pane.classList.add('show','active');
            }
        });
    });
});
window.addEventListener('load', function() {
    // Correction de secours : si aucun .tab-pane n'est visible, force l'affichage du premier
    var visible = false;
    document.querySelectorAll('.tab-pane').forEach(function(p){
        if (p.classList.contains('show') && p.classList.contains('active')) {
            visible = true;
        }
    });
    if (!visible) {
        var firstTab = document.querySelector('.nav-link');
        var firstPane = document.querySelector('.tab-pane');
        if (firstTab && firstPane) {
            firstTab.classList.add('active');
            firstTab.setAttribute('aria-selected', 'true');
            firstPane.classList.add('show','active');
        }
    }
});
</script>


