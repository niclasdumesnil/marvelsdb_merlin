{% macro pack_list(data, types, creator_labels, visibility) %}
    <style>
        .creator-box {
            background: #fcfdfdff;
            border-radius: 12px;
            padding: 8px 0px 8px 0px;
            margin: 1px 0.2em 0px -2.5em;
            position: relative;
        }
        .creator-label {
            position: absolute;
            top: 0px;
            right: 14px;
            font-size: 0.85em;
            color: #2266aa;
            font-weight: bold;
        }
        .creator-list {
            margin-left: 0em;
            margin-bottom: -0.2em;
            font-size: 1em;
            margin-top: 0.9em;
        }
        .creator-li {
            list-style: none;
            padding-left: 0;
            margin-left: 0;
        }
        .french-only-tag {
            background: linear-gradient(90deg, #0055A4 0%, #fff 50%, #EF4135 100%);
            color: #111;
            font-size: 10px;
            border-radius: 8px;
            padding: 2px 12px;
            display: inline-flex;
            align-items: center;
            margin-left: 8px;
            border: 1px solid #222;
            font-weight: bold;
            text-shadow: 1px 1px 2px #fff;
        }
        .status-tag {
            font-size: 10px;
            display: inline-flex;
            align-items: center;
            border-radius: 8px;
            padding: 2px 12px;
            margin-left: 8px;
            font-weight: bold;
        }
        .status-tag.alpha, .status-tag.beta {
            color: #111;
            background-color: rgb(216, 150, 8);
        }
        {# .status-tag.released, .status-tag.sealed {
            color: #fff;
            background-color: rgb(0, 48, 27);
        } #}
    </style>
    <ol>
        {% for type in types %}
            {% set first_pack = (data
                |filter(p => p.creator != 'FFG'
                    and (visibility is null or p.visibility == visibility)
                    and p.type == type
                )|first) %}
            <span style="display:inline-block; background:rgb(9, 58, 2); color:#fff; border-radius:6px; padding:2px 12px; margin:6px 0 6px 0; font-weight:semi;">
                {% if first_pack is defined and first_pack %}
                    {{ first_pack.type_name }}
                {% endif %}
            </span>
            <br>
            {% set packs_of_type = data
                |filter(p => p.creator != 'FFG'
                    and (visibility is null or p.visibility == visibility)
                    and p.type == type
                )
                |sort((a, b) =>
                    a.creator|lower < b.creator|lower
                        ? -1
                        : (a.creator|lower > b.creator|lower
                            ? 1
                            : (a.name < b.name
                                ? -1
                                : (a.name > b.name ? 1 : 0)
                            )
                        )
                )
            %}
            {% set seen_creators = [] %}
            {% for pack in packs_of_type %}
                {% if pack.creator not in seen_creators %}
                    {% set seen_creators = seen_creators|merge([pack.creator]) %}
                    <li class="creator-li">
                        <div class="creator-box">
                            <span class="creator-label">
                                {{ creator_labels[pack.creator] ?? pack.creator }}
                            </span>
                            <ol class="creator-list">
                            {% for subpack in packs_of_type if subpack.creator == pack.creator %}
                                <li style="margin-left:0em; font-size: 1em;">
                                    <a title="{{ subpack.name }}" href="{{ subpack.url }}">{{ subpack.name }}</a>
                                    {% if subpack.status in ["alpha", "beta"] %}
                                        <span class="status-tag {{ subpack.status }}">{{ subpack.status ?? 'Official' }}</span>
                                    {% endif %}
                                    {# {% if subpack.status in ["released", "sealed"] %}
                                        <span class="status-tag {{ subpack.status }}">{{ subpack.status ?? 'Official' }}</span>
                                    {% endif %} #}
                                    {% if subpack.pack_type_code is defined and subpack.pack_type_code == 'hero_fanmade' %}
                                        <span style="font-size: 10px; color: #fff; background-color: #8a246d; display: inline-flex;
                                            align-items: center; border-radius: 8px; padding: 2px 12px; margin-left: 8px;">Custom Hero Pack</span>
                                    {% endif %}
                                    {# Tag French Only si la langue du pack est "fr" #}
                                    {% if subpack.language is defined and subpack.language == "fr" %}
                                        <span class="french-only-tag">French only</span>
                                    {% endif %}
                                </li>
                            {% endfor %}
                            </ol>
                        </div>
                    </li>
                {% endif %}
            {% endfor %}
        {% endfor %}
    </ol>
{% endmacro %}

{% import _self as macros %}

{% set creator_colors = {
    'default': 'rgb(18, 120, 216)',
    'createur1': 'rgb(158, 14, 187)',
    'createur2': 'rgb(3, 88, 84)'
} %}
{% set creator_labels = {
    'Merlin': 'Merlin',
    'Designhacker': 'Hax'
} %}

<ul class="nav nav-tabs" id="packsTabs" role="tablist" style="margin-bottom:1em;">
    <li class="nav-item" role="presentation">
        <a class="nav-link active" id="ffg-tab" data-toggle="tab" href="#ffg" role="tab" aria-controls="ffg" aria-selected="true">Current</a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link" id="fanmade-tab" data-toggle="tab" href="#fanmade" role="tab" aria-controls="fanmade" aria-selected="false">Fan made</a>
    </li>
    {% if app.user and app.user.donation == "1" %}
    <li class="nav-item" role="presentation">
        <a class="nav-link" id="private-tab" data-toggle="tab" href="#private" role="tab" aria-controls="private" aria-selected="false">Private</a>
    </li>
    {% endif %}
</ul>
<div class="tab-content" id="packsTabsContent">
    <div class="tab-pane fade show active" id="ffg" role="tabpanel" aria-labelledby="ffg-tab">
        <ol>
            <span style="display:inline-block; background:rgb(70, 68, 68); color:#fff; border-radius:6px; padding:2px 12px; margin:6px 0 6px 0; font-weight:semi;">FFG</span>
            {% for pack in data %}
                {% if pack.creator == 'FFG' %}
                    {% if pack.type == 'core' or pack.type == 'story' or pack.type =='encounter' %}
                        <li>
                            <a href="{{ pack.url }}">{{ pack.name }}</a>
                            <span>
                                {% if pack.available == false %}({{ pack.known }} cards){% endif %}
                            </span>
                        </li>
                    {% else %}
                        <li style="margin-left:2em;">
                            <a href="{{ pack.url }}">{{ pack.name }}</a>
                            <span>
                                {% if pack.available == false %}({{ pack.known }} cards){% endif %}
                            </span>
                        </li>
                    {% endif %}
                {% endif %}
            {% endfor %}
        </ol>
    </div>
    <div class="tab-pane fade" id="fanmade" role="tabpanel" aria-labelledby="fanmade-tab">
        {% set fan_types = [] %}
        {% for pack in data %}
            {% if pack.creator != 'FFG' and pack.visibility != "false" and (pack.type is not empty) and (pack.type not in fan_types) %}
                {% set fan_types = fan_types|merge([pack.type]) %}
            {% endif %}
        {% endfor %}
        {{ macros.pack_list(data, fan_types, creator_labels, "true") }}
    </div>
    {% if app.user and app.user.donation == "1" %}
    <div class="tab-pane fade" id="private" role="tabpanel" aria-labelledby="private-tab">
        {% set private_types = [] %}
        {% for pack in data %}
            {% if pack.creator != 'FFG' and pack.visibility == "false" and (pack.type is not empty) and (pack.type not in private_types) %}
                {% set private_types = private_types|merge([pack.type]) %}
            {% endif %}
        {% endfor %}
        {{ macros.pack_list(data, private_types, creator_labels, "false") }}
    </div>
    {% endif %}
</div>

<style>
.tab-pane {
  display: none;
}
.tab-pane.show.active {
  display: block !important;
  color: inherit !important;
  background: inherit !important;
  visibility: visible !important;
  opacity: 1 !important;
  z-index: auto !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Désactive tous les onglets et contenus
    document.querySelectorAll('.nav-link').forEach(function(t){
        t.classList.remove('active');
        t.setAttribute('aria-selected', 'false');
    });
    document.querySelectorAll('.tab-pane').forEach(function(p){
        p.classList.remove('show','active');
    });
    var ffgTab = document.getElementById('ffg-tab');
    var ffgPane = document.getElementById('ffg');
    if(ffgTab && ffgPane) {
        ffgTab.classList.add('active');
        ffgTab.setAttribute('aria-selected', 'true');
        ffgPane.classList.add('show','active');
    }

    // Gestion du clic sur les onglets
    document.querySelectorAll('.nav-link').forEach(function(tab) {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelectorAll('.nav-link').forEach(function(t){
                t.classList.remove('active');
                t.setAttribute('aria-selected', 'false');
            });
            tab.classList.add('active');
            tab.setAttribute('aria-selected', 'true');
            document.querySelectorAll('.tab-pane').forEach(function(p){
                p.classList.remove('show','active');
            });
            var pane = document.querySelector(tab.getAttribute('href'));
            if(pane) {
                pane.classList.add('show','active');
            }
        });
    });
});
window.addEventListener('load', function() {
    // Correction de secours : si aucun .tab-pane n'est visible, force l'affichage du premier
    var visible = false;
    document.querySelectorAll('.tab-pane').forEach(function(p){
        if (p.classList.contains('show') && p.classList.contains('active')) {
            visible = true;
        }
    });
    if (!visible) {
        var firstTab = document.querySelector('.nav-link');
        var firstPane = document.querySelector('.tab-pane');
        if (firstTab && firstPane) {
            firstTab.classList.add('active');
            firstTab.setAttribute('aria-selected', 'true');
            firstPane.classList.add('show','active');
        }
    }
});
</script>


