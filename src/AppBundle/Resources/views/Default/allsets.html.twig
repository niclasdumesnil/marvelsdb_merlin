{% macro pack_list(data, types, creator_labels, visibility) %}
    <ul class="pack-list" style="margin:0;padding:0;border:none;">
        {% for type in types %}
            {% set first_pack = (data
                |filter(p => p.creator != 'FFG'
                    and (visibility is null or p.visibility == visibility)
                    and p.type == type
                )|first) %}
            <span class="pack-type-label
                {% if first_pack.type == 'hero_fanmade' %} pack-type-name-hero
                {% elseif first_pack.type == 'fm_theme' %} pack-type-name-theme
                {% elseif first_pack.type == 'scenar_fanmade' %} pack-type-name-scenario
                {% elseif first_pack.type == 'fm_story' %} pack-type-name-campaign
                {% endif %}
            ">
                {{ first_pack.type_name }}
            </span>
            <br>
            {% set packs_of_type = data
                |filter(p => p.creator != 'FFG'
                    and (visibility is null or p.visibility == visibility)
                    and p.type == type
                )
                |sort((a, b) => a.name|lower < b.name|lower ? -1 : (a.name|lower > b.name|lower ? 1 : 0))
            %}
            {% for pack in packs_of_type %}
                <li class="creator-li" style="margin:0;padding:0;border:none;">
                    <div class="creator-box" style="margin:0;padding:0;border:none;">
                        <ul class="creator-list" style="margin:0;padding:0;border:none;">
                            <li style="margin:0;padding:0;border:none;">
                                {% if pack.status in ["alpha","beta","released","sealed"] %}
                                    <span class="status-dot status-dot-{{ pack.status }}" title="{{ pack.status|capitalize }}">
                                        {% if pack.status == 'alpha' %}Î±{% elseif pack.status == 'beta' %}Î²{% elseif pack.status == 'released' %}R{% elseif pack.status == 'sealed' %}S{% endif %}
                                    </span>
                                {% endif %}
                                <span class="set-name-hover" style="position:relative; display:inline-flex; align-items:center; gap:6px;">
                                    <a title="{{ pack.name }}" href="{{ pack.url }}">{{ pack.name }}</a>
                                    {% if pack.language is defined and pack.language == "fr" %}
                                        <span class="fr-flag" title="French only">ðŸ‡«ðŸ‡·</span>
                                    {% endif %}
                                    {#
                                    {% if pack.status in ["alpha","beta","released","sealed"] %}
                                        <span class="tag status status-{{ pack.status }}">
                                            {% if pack.status == 'alpha' %}alpha{% elseif pack.status == 'beta' %}beta{% elseif pack.status == 'released' %}released{% elseif pack.status == 'sealed' %}sealed{% endif %}
                                        </span>
                                    {% endif %}
                                    #}
                                    <span class="creator-hover-box" style="display:inline;">
                                        <span class="tag creator">{{ creator_labels[pack.creator] ?? pack.creator }}</span>
                                    </span>
                                </span>
                                {% if pack.pack_type_code is defined and pack.pack_type_code == 'hero_fanmade' %}
                                    <span class="tag custom-hero">Custom Hero Pack</span>
                                {% endif %}
                                {% if pack.creator is not defined or pack.creator == "FFG" or pack.creator == "" %}
                                    <span class="tag ffg">FFG</span>
                                {% endif %}
                            </li>
                        </ul>
                        {# Suppression de l'affichage sÃ©parÃ© du crÃ©ateur #}
                    </div>
                </li>
            {% endfor %}
        {% endfor %}
    </ul>
{% endmacro %}

{% import _self as macros %}

{% set creator_colors = {
    'default': 'rgb(18, 120, 216)',
    'createur1': 'rgb(158, 14, 187)',
    'createur2': 'rgb(3, 88, 84)'
} %}
{% set creator_labels = {
    'Merlin': 'Merlin',
    'Designhacker': 'Hax'
} %}

<ul class="nav nav-tabs" id="packsTabs" role="tablist" style="margin-bottom:1em;">
    <li class="nav-item" role="presentation">
        <a class="nav-link active" id="ffg-tab" data-toggle="tab" href="#ffg" role="tab" aria-controls="ffg" aria-selected="true">Current</a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link" id="fanmade-tab" data-toggle="tab" href="#fanmade" role="tab" aria-controls="fanmade" aria-selected="false">Fan made</a>
    </li>
    {% if app.user and app.user.donation == "1" %}
    <li class="nav-item" role="presentation">
        <a class="nav-link" id="private-tab" data-toggle="tab" href="#private" role="tab" aria-controls="private" aria-selected="false">Private</a>
    </li>
    {% endif %}
</ul>
<div class="tab-content" id="packsTabsContent">
    <div class="tab-pane fade show active" id="ffg" role="tabpanel" aria-labelledby="ffg-tab">
        <ol>
            <span style="display:inline-block; background:rgb(70, 68, 68); color:#fff; border-radius:6px; padding:2px 12px; margin:6px 0 6px 0; font-weight:semi;">FFG</span>
            {% for pack in data %}
                {% if pack.creator == 'FFG' %}
                    {% if pack.type == 'core' or pack.type == 'story' or pack.type =='encounter' %}
                        <li>
                            <a href="{{ pack.url }}">{{ pack.name }}</a>
                            <span>
                                {% if pack.available == false %}({{ pack.known }} cards){% endif %}
                            </span>
                        </li>
                    {% else %}
                        <li style="margin-left:2em;">
                            <a href="{{ pack.url }}">{{ pack.name }}</a>
                            <span>
                                {% if pack.available == false %}({{ pack.known }} cards){% endif %}
                            </span>
                        </li>
                    {% endif %}
                {% endif %}
            {% endfor %}
        </ol>
    </div>
    <div class="tab-pane fade" id="fanmade" role="tabpanel" aria-labelledby="fanmade-tab">
        {% set fan_types = [] %}
        {% for pack in data %}
            {% if pack.creator != 'FFG' and pack.visibility != "false" and (pack.type is not empty) and (pack.type not in fan_types) %}
                {% set fan_types = fan_types|merge([pack.type]) %}
            {% endif %}
        {% endfor %}
        {{ macros.pack_list(data, fan_types, creator_labels, "true") }}
    </div>
    {% if app.user and app.user.donation == "1" %}
    <div class="tab-pane fade" id="private" role="tabpanel" aria-labelledby="private-tab">
        {% set private_types = [] %}
        {% for pack in data %}
            {% if pack.creator != 'FFG' and pack.visibility == "false" and (pack.type is not empty) and (pack.type not in private_types) %}
                {% set private_types = private_types|merge([pack.type]) %}
            {% endif %}
        {% endfor %}
        {{ macros.pack_list(data, private_types, creator_labels, "false") }}
    </div>
    {% endif %}
</div>

<style>
.tab-pane {
  display: none;
}
.tab-pane.show.active {
  display: block !important;
  color: inherit !important;
  background: inherit !important;
  visibility: visible !important;
  opacity: 1 !important;
  z-index: auto !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // DÃ©sactive tous les onglets et contenus
    document.querySelectorAll('.nav-link').forEach(function(t){
        t.classList.remove('active');
        t.setAttribute('aria-selected', 'false');
    });
    document.querySelectorAll('.tab-pane').forEach(function(p){
        p.classList.remove('show','active');
    });
    var ffgTab = document.getElementById('ffg-tab');
    var ffgPane = document.getElementById('ffg');
    if(ffgTab && ffgPane) {
        ffgTab.classList.add('active');
        ffgTab.setAttribute('aria-selected', 'true');
        ffgPane.classList.add('show','active');
    }

    // Gestion du clic sur les onglets
    document.querySelectorAll('.nav-link').forEach(function(tab) {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelectorAll('.nav-link').forEach(function(t){
                t.classList.remove('active');
                t.setAttribute('aria-selected', 'false');
            });
            tab.classList.add('active');
            tab.setAttribute('aria-selected', 'true');
            document.querySelectorAll('.tab-pane').forEach(function(p){
                p.classList.remove('show','active');
            });
            var pane = document.querySelector(tab.getAttribute('href'));
            if(pane) {
                pane.classList.add('show','active');
            }
        });
    });
});
window.addEventListener('load', function() {
    // Correction de secoursÂ : si aucun .tab-pane n'est visible, force l'affichage du premier
    var visible = false;
    document.querySelectorAll('.tab-pane').forEach(function(p){
        if (p.classList.contains('show') && p.classList.contains('active')) {
            visible = true;
        }
    });
    if (!visible) {
        var firstTab = document.querySelector('.nav-link');
        var firstPane = document.querySelector('.tab-pane');
        if (firstTab && firstPane) {
            firstTab.classList.add('active');
            firstTab.setAttribute('aria-selected', 'true');
            firstPane.classList.add('show','active');
        }
    }
});
</script>


