<script>
document.addEventListener('DOMContentLoaded', function() {
	var printBtn = document.getElementById('btn-print');
	if (!printBtn) return;

	var deckId = '{{ decklist.id }}';
	var files = [deckId + '-type.jpg', deckId + '-faction.jpg'];

	// Fonction utilitaire pour charger une image et appeler les callbacks
	function loadImage(file, onLoad, onError) {
		var img = new window.Image();
		img.onload = function() { onLoad && onLoad(img, file); };
		img.onerror = function() { onError && onError(file); };
		img.src = '/bundles/public_decks/' + file;
	}

	// Vérifie l'existence d'au moins une image pour activer le bouton print
	loadImage(files[0], function() {
		printBtn.disabled = false;
		printBtn.classList.remove('disabled');
		printBtn.style.opacity = '';
		printBtn.style.pointerEvents = '';
		printBtn.title = '';
	}, function() {
		printBtn.disabled = true;
		printBtn.classList.add('disabled');
		printBtn.style.opacity = '0.5';
		printBtn.style.pointerEvents = 'none';
		printBtn.title = "Aucune image à imprimer n'a été trouvée pour ce deck.";
	});

	printBtn.addEventListener('click', function(e) {
		e.preventDefault();
		var loadedImages = [];
		var checkedPrint = 0;
		files.forEach(function(file) {
			loadImage(file, function(img, file) {
				loadedImages.push({file: file, img: img});
				checkDonePrint();
			}, function() {
				checkDonePrint();
			});
		});
		function checkDonePrint() {
			checkedPrint++;
			if (checkedPrint === files.length) {
				var win = window.open('', '_blank');
				if (win) {
					var html = '<html><head><title>Deck Images</title>' +
						'<style>body{margin:0;padding:0;background:#222;} .img-row{display:flex;justify-content:center;align-items:flex-start;gap:2vw;margin:2vw 0;} .img-row img{width:50vw;max-width:50vw;height:auto;box-shadow:0 0 12px #000;background:#fff;border-radius:8px;} .error-msg{color:#fff;text-align:center;font-size:1.5em;margin:4vw 0;}</style>' +
						'</head><body>';
					if (loadedImages.length > 0) {
						html += '<div class="img-row">';
						loadedImages.forEach(function(obj) {
							html += '<img src="/bundles/public_decks/' + obj.file + '">';
						});
						html += '</div>';
					} else {
						html += '<div class="error-msg">Aucune image à imprimer n’a été trouvée pour ce deck.</div>';
					}
					html += '</body></html>';
					win.document.write(html);
					win.document.close();
				} else {
					alert('Popup blocked! Please allow popups for this site.');
				}
			}
		}
	});
});
</script>
<a href="{{ path('decklist_edit', {decklist_id:decklist.id}) }}" title="Edit decklist name / description" id="decklist-edit" class="btn btn-sm btn-default" style="display:none">
	<span class="fa fa-pencil text-primary"></span> Edit
</a>
<a href="#" title="Delete decklist" id="decklist-delete" class="btn btn-sm btn-default" style="display:none">
	<span class="fa fa-trash-o text-danger"></span> Delete
</a>
<a href="{{ path('deck_copy', {decklist_id:decklist.id}) }}" class="btn btn-sm btn-default">
	<span class="fa fa-save"></span> <span class="hidden-xs">Copy</span>
</a>
<div class="btn-group">
	<button type="button" class="btn btn-sm btn-default dropdown-toggle " data-toggle="dropdown">
		<span class="fa fa-download"></span> <span class="hidden-xs">Download</span> <span class="caret"></span>
	</button>
	<ul class="dropdown-menu" role="menu">
		<li><a href="#" id="btn-download-text">Text file</a></li>
		<li><a {% if not octgnable %} onclick="window.alert('Warning: Some cards from this deck are missing OCTGN IDs (most likely the latest cards or the special random basic weakness card)')" {% endif %}href="#" id="btn-download-octgn">Octgn file</a></li>
	</ul>
</div>
<a href="#" title="Print decklist" id="btn-print" class="btn btn-sm btn-default">
	<span class="fa fa-print"></span> <span class="hidden-xs">Print</span>
</a>
{#
<div class="btn-group">
	<button type="button" class="btn btn-sm btn-default dropdown-toggle " data-toggle="dropdown">
		<span class="fa fa-clipboard"></span> <span class="hidden-xs">Export</span> <span class="caret"></span>
	</button>
	<ul class="dropdown-menu" role="menu">
		<li><a href="#" id="btn-export-bbcode">bbCode</a></li>
		<li><a href="#" id="btn-export-markdown">Markdown (Reddit)</a></li>
		<li><a href="#" id="btn-export-plaintext">plain text</a></li>
	</ul>
</div>
#}
<div class="btn-group">
	<button type="button" class="btn btn-sm btn-default dropdown-toggle " data-toggle="dropdown">
		<span class="fa fa-sort"></span> <span class="hidden-xs">Sort</span> <span class="caret"></span>
	</button>
	<ul class="dropdown-menu" role="menu" id="menu-sort">
		<li><a href="#" onclick="app.deck.change_sort('default')" id="btn-sort-default">by Type</a></li>
		<li><a href="#" onclick="app.deck.change_sort('name')" id="btn-sort-name">by Name</a></li>
		<li><a href="#" onclick="app.deck.change_sort('number')" id="btn-sort-faction">by Card Number</a></li>
		<li><a href="#" onclick="app.deck.change_sort('cost')" id="btn-sort-faction">by Cost</a></li>
		<li><a href="#" onclick="app.deck.change_sort('set')" id="btn-sort-position">by Set, then Name</a></li>
		<li><a href="#" onclick="app.deck.change_sort('settype')" id="btn-sort-position">by Set, then Type</a></li>
		<li><a href="#" onclick="app.deck.change_sort('setnumber')" id="btn-sort-position">by Set, then Card Number</a></li>
		<li><a href="#" onclick="app.deck.change_sort('faction')" id="btn-sort-faction">by Aspect, then Name</a></li>
		<li><a href="#" onclick="app.deck.change_sort('factiontype')" id="btn-sort-faction">by Aspect, then Type</a></li>
		<li><a href="#" onclick="app.deck.change_sort('factioncost')" id="btn-sort-faction">by Aspect, then Cost</a></li>
		<li><a href="#" onclick="app.deck.change_sort('factionnumber')" id="btn-sort-faction">by Aspect, then Card Number</a></li>
	</ul>
</div>
{#
<button type="button" id="btn-compare" class="btn btn-sm btn-default">
	<span class="fa fa-duplicate"></span> <span class="hidden-xs">Compare</span>
</button>
#}
