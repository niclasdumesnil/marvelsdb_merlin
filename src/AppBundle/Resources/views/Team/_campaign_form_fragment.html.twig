<style>
    .campaign-ui { font-family: 'Segoe UI', system-ui, sans-serif; color: #2c3e50; }
    .ui-card { background: #fff; border: 1px solid #e0e6ed; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .section-header { font-size: 0.85rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; color: #95a5a6; border-bottom: 2px solid #f8f9fa; padding-bottom: 0.5rem; margin-bottom: 1.25rem; }
    
    .player-slot { background: #fdfdfd; border: 1px solid #f0f0f0; border-radius: 10px; padding: 12px; }
    
    .comic-label { font-size: 0.8rem; font-weight: 700; text-transform: uppercase; color: #95a5a6; display: block; margin-bottom: 0.25rem; }
    .comic-input { border: 1px solid #e0e6ed; border-radius: 6px; padding: 0.5rem; font-family: inherit; transition: all 0.2s; }
    /* Styles dynamiques pour la santé */
    .hp-at-max { font-weight: 800 !important; color: #2c3e50 !important; }
    .hp-damaged { color: #e74c3c !important; font-weight: 800 !important; background-color: #fff5f5 !important; border-color: #fab1a0 !important; }

    /* Champ de recherche avec croix d'effacement */
    .search-wrapper { position: relative; display: flex; align-items: center; }
    .search-clear { 
        position: absolute; right: 12px; cursor: pointer; color: #ccc; 
        font-size: 1.2rem; display: none; transition: color 0.2s; 
    }
    .search-clear:hover { color: #e74c3c; }

    .scenario-nav-bar { background: #2c3e50; color: #fff; border-radius: 12px 12px 0 0; padding: 12px 20px; display: flex; align-items: center; gap: 15px; }
    .scenario-select-custom { background: #3e4f5f; color: white; border: 1px solid #555; border-radius: 6px; padding: 5px 10px; flex-grow: 1; outline: none; }
    .scenario-content { border: 1px solid #e0e6ed; border-top: none; border-radius: 0 0 12px 12px; padding: 2rem; background: #fff; }
    
    .campaign-ui .card-row { display: flex; align-items: center; gap: 15px; background: #fff; border-bottom: 1px solid #eee; padding: 8px 0; }
    .campaign-ui .card-img-container { width: 65px; flex-shrink: 0; display: flex; justify-content: center; }
    .campaign-ui .card-thumbnail { width: 100%; border-radius: 4px; background: #eee; }
    
    /* Séparateur Comics */
    .deck-divider-container { margin: 30px 0; position: relative; display: flex; align-items: center; justify-content: center; }
    .deck-divider-line { position: absolute; width: 100%; height: 2px; background: #e0e6ed; z-index: 1; }
    .deck-divider-badge { position: relative; z-index: 2; background: #2c3e50; color: #fff; padding: 6px 25px; font-weight: 900; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 2px; transform: skew(-15deg); border-left: 4px solid #e74c3c; box-shadow: 4px 4px 0 rgba(0,0,0,0.1); }
    .deck-divider-text { transform: skew(15deg); display: inline-block; }

    /* Qty buttons: slight rounding on the whole block; buttons stay flush */
    /* keep group sized to its contents so no empty rounded area appears */
    .qty-btn-group { display: inline-flex; gap: 0; flex-shrink: 0; border-radius: 6px; overflow: hidden; border: 1px solid #d0d6dc; vertical-align:middle; }
    /* Uniform button sizing regardless of count (slightly smaller) */
    .qty-btn { padding: 4px 8px; font-size: 0.86rem; border: none; background: #f6f7f8; color: #333; cursor: pointer; font-weight: 600; border-radius: 0; min-width:30px; text-align:center; }
    .qty-btn + .qty-btn { margin-left: 0; }
    .qty-btn.active { background: #2f80ed; color: white; }

    /* Larger card name across this component; override below for the campaign list table to keep columns aligned */
    .campaign-ui a.card-link { font-size: 1.5rem !important; font-weight:700 !important; color: #2c3e50 !important; }
    /* Reduce the name font-size inside the Active Campaign Deck table so both tables keep similar column widths */
    #list-card-{{ campaignlist.getId() }} a.card-link { font-size: 1.5rem !important; font-weight:700 !important; }
    .qty-btn.disabled { opacity: 0.45; cursor: not-allowed; }
    /* Compact owner select to match qty buttons height & increase font
       Use stronger selector and !important to override Bootstrap form-control */
    .owner-select, select.owner-select.form-control {
        padding: 0 8px !important;
        font-size: 1.1rem !important; /* increased font without changing height */
        height: 26px !important; /* keep compact height */
        line-height: 26px !important; /* center text vertically */
        border-radius: 4px !important;
        display: inline-block !important;
        vertical-align: middle !important;
        box-sizing: border-box !important;
        max-height: 26px !important;
        overflow: hidden !important;
        /* hide native caret to avoid duplicate arrows */
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        appearance: none !important;
        padding-top: 0 !important;
        padding-bottom: 0 !important;
        /* SVG caret on the right */
        background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24'><path fill='%23333' d='M7 10l5 5 5-5z'/></svg>") !important;
        background-repeat: no-repeat !important;
        background-position: right 8px center !important;
        background-size: 12px 12px !important;
        padding-right: 34px !important; /* space for the caret */
    }
    /* Faction filter: selected (active) buttons use a dark grey */
    .campaign-ui .btn-outline-secondary.active,
    .campaign-ui .btn-outline-secondary.active:focus,
    .campaign-ui #faction-filters-{{ campaignlist.getId() }} .btn.active,
    .campaign-ui #faction-filters-{{ campaignlist.getId() }} .btn.active:focus {
        background-color: #2f3542 !important;
        color: #ffffff !important;
        border-color: #2f3542 !important;
        box-shadow: none !important;
    }
    .campaign-ui #faction-filters-{{ campaignlist.getId() }} .btn {
        transition: background-color 0.12s ease, color 0.12s ease;
    }
    
    #floating-card-preview { position: fixed; pointer-events: none; z-index: 10000; display: none; background: #fff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); padding: 15px; width: 300px; border: 1px solid #ddd; }
    #auto-save-indicator { position: fixed; bottom: 30px; right: 30px; padding: 12px 24px; border-radius: 50px; background: #2c3e50; color: white; font-weight: 600; display: none; z-index: 9999; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }

    /* Force consistent column widths for results and campaign list tables so columns align
       Use fixed layout and explicit widths that match the table markup used in JS renderers */
    #results-card-{{ campaignlist.getId() }} .table,
    #list-card-{{ campaignlist.getId() }} .table {
        table-layout: fixed;
        width: 100%;
    }
    /* Column widths: 1=Quantity, 2=Name, 3=Icons, 4=Cost, 5=Type, 6=Traits (flex), 7=Pack, 8=Owner */
    #results-card-{{ campaignlist.getId() }} .table th:nth-child(1),
    #list-card-{{ campaignlist.getId() }} .table th:nth-child(1),
    #results-card-{{ campaignlist.getId() }} .table td:nth-child(1),
    #list-card-{{ campaignlist.getId() }} .table td:nth-child(1) { width:110px; max-width:110px; }

    #results-card-{{ campaignlist.getId() }} .table th:nth-child(2),
    #list-card-{{ campaignlist.getId() }} .table th:nth-child(2),
    #results-card-{{ campaignlist.getId() }} .table td:nth-child(2),
    #list-card-{{ campaignlist.getId() }} .table td:nth-child(2) { width:260px; min-width:160px; }

    #results-card-{{ campaignlist.getId() }} .table th:nth-child(3),
    #list-card-{{ campaignlist.getId() }} .table th:nth-child(3),
    #results-card-{{ campaignlist.getId() }} .table td:nth-child(3),
    #list-card-{{ campaignlist.getId() }} .table td:nth-child(3) { width:80px; max-width:80px; }

    #results-card-{{ campaignlist.getId() }} .table th:nth-child(4),
    #list-card-{{ campaignlist.getId() }} .table th:nth-child(4),
    #results-card-{{ campaignlist.getId() }} .table td:nth-child(4),
    #list-card-{{ campaignlist.getId() }} .table td:nth-child(4) { width:60px; max-width:60px; }

    #results-card-{{ campaignlist.getId() }} .table th:nth-child(5),
    #list-card-{{ campaignlist.getId() }} .table th:nth-child(5),
    #results-card-{{ campaignlist.getId() }} .table td:nth-child(5),
    #list-card-{{ campaignlist.getId() }} .table td:nth-child(5) { width:100px; max-width:100px; }

    #results-card-{{ campaignlist.getId() }} .table th:nth-child(7),
    #list-card-{{ campaignlist.getId() }} .table th:nth-child(7),
    #results-card-{{ campaignlist.getId() }} .table td:nth-child(7),
    #list-card-{{ campaignlist.getId() }} .table td:nth-child(7) { width:140px; max-width:140px; }

    #results-card-{{ campaignlist.getId() }} .table th:nth-child(8),
    #list-card-{{ campaignlist.getId() }} .table th:nth-child(8),
    #results-card-{{ campaignlist.getId() }} .table td:nth-child(8),
    #list-card-{{ campaignlist.getId() }} .table td:nth-child(8) { width:160px; max-width:160px; }

    /* Make name links truncate with ellipsis when too long, keep consistent visual height */
    #results-card-{{ campaignlist.getId() }} .table td:nth-child(2) a.card-link,
    #list-card-{{ campaignlist.getId() }} .table td:nth-child(2) a.card-link {
        display:inline-block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%;
    }

    /* Responsive: revert fixed layout on medium/small screens so table can wrap or scroll
       - remove fixed widths on cells and allow wrapping of name/pack
       - keep horizontal scrolling available via .table-responsive when content still overflows */
    @media (max-width: 992px) {
        #results-card-{{ campaignlist.getId() }} .table,
        #list-card-{{ campaignlist.getId() }} .table { table-layout: auto; }

        /* Clear explicit widths set earlier so cells can reflow */
        #results-card-{{ campaignlist.getId() }} .table th,
        #results-card-{{ campaignlist.getId() }} .table td,
        #list-card-{{ campaignlist.getId() }} .table th,
        #list-card-{{ campaignlist.getId() }} .table td {
            width: auto !important;
            max-width: none !important;
        }

        /* Allow card names and pack names to wrap on small screens */
        #results-card-{{ campaignlist.getId() }} .table td:nth-child(2) a.card-link,
        #list-card-{{ campaignlist.getId() }} .table td:nth-child(2) a.card-link {
            white-space: normal !important; display:block; overflow:visible; text-overflow:clip;
        }
        #results-card-{{ campaignlist.getId() }} .table td:nth-child(7),
        #list-card-{{ campaignlist.getId() }} .table td:nth-child(7) {
            white-space: normal !important; word-break: break-word; overflow:visible;
        }

        /* Ensure the responsive wrapper allows horizontal scroll on very small screens */
        #results-card-{{ campaignlist.getId() }} .table-responsive,
        #list-card-{{ campaignlist.getId() }} .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
    }

    /* Removed stacked rows behavior — prefer table wrapping/scrolling on small screens.
       Stacked card blocks were reverted after user feedback. If you want stacked rows
       re-enabled, we can reintroduce them behind a feature flag or at a different breakpoint. */

    /* Tablet — landscape: keep table format but reduce name column and control sizes */
    @media (max-width: 1280px) {
        #results-card-{{ campaignlist.getId() }} .table td:nth-child(2),
        #list-card-{{ campaignlist.getId() }} .table td:nth-child(2) {
            width: 220px !important; min-width: 140px !important;
        }
        .campaign-ui a.card-link { font-size: 1.35rem !important; }
        .qty-btn { padding: 3px 6px; min-width: 28px; font-size: 0.82rem; }
        .owner-select, select.owner-select.form-control { font-size: 1rem !important; height: 24px !important; line-height:24px !important; }
        /* Tablet landscape: hide Pack column and clamp Traits to avoid multi-line wrapping */
        #results-card-{{ campaignlist.getId() }} .table th:nth-child(7),
        #list-card-{{ campaignlist.getId() }} .table th:nth-child(7),
        #results-card-{{ campaignlist.getId() }} .table td:nth-child(7),
        #list-card-{{ campaignlist.getId() }} .table td:nth-child(7) {
            display: none !important;
        }
        #results-card-{{ campaignlist.getId() }} .table td:nth-child(6),
        #list-card-{{ campaignlist.getId() }} .table td:nth-child(6) {
            max-width: 140px !important; white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important;
        }
        /* Slightly reduce icon/owner width to gain space */
        #results-card-{{ campaignlist.getId() }} .table td:nth-child(3),
        #list-card-{{ campaignlist.getId() }} .table td:nth-child(3) { width: 60px !important; max-width:60px !important; }
        #results-card-{{ campaignlist.getId() }} .table td:nth-child(8) select,
        #list-card-{{ campaignlist.getId() }} .table td:nth-child(8) select { width:120px !important; }
    }

    /* Tablet — portrait and small tablets: allow wrapping but prevent awkward multi-line Pack/Traits
       and keep controls compact. Fall back to horizontal scroll if needed. */
    @media (max-width: 768px) {
        #results-card-{{ campaignlist.getId() }} .table,
        #list-card-{{ campaignlist.getId() }} .table { table-layout: auto; }

        /* Reduce title size to fit more content on narrow tablets */
        .campaign-ui a.card-link { font-size: 1.15rem !important; }

        /* Keep icons centered and compact */
        #results-card-{{ campaignlist.getId() }} .table td:nth-child(3),
        #list-card-{{ campaignlist.getId() }} .table td:nth-child(3) { text-align: center; }

        /* Prevent Pack and Traits from expanding rows excessively — clamp and ellipsis */
        #results-card-{{ campaignlist.getId() }} .table td:nth-child(6),
        #list-card-{{ campaignlist.getId() }} .table td:nth-child(6),
        #results-card-{{ campaignlist.getId() }} .table td:nth-child(7),
        #list-card-{{ campaignlist.getId() }} .table td:nth-child(7) {
            white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important; max-width: 140px !important;
        }

        /* Hide lower-priority columns on narrow tablets to avoid awkward multi-line rows */
        #results-card-{{ campaignlist.getId() }} .table th:nth-child(6),
        #list-card-{{ campaignlist.getId() }} .table th:nth-child(6),
        #results-card-{{ campaignlist.getId() }} .table td:nth-child(6),
        #list-card-{{ campaignlist.getId() }} .table td:nth-child(6),
        #results-card-{{ campaignlist.getId() }} .table th:nth-child(7),
        #list-card-{{ campaignlist.getId() }} .table th:nth-child(7),
        #results-card-{{ campaignlist.getId() }} .table td:nth-child(7),
        #list-card-{{ campaignlist.getId() }} .table td:nth-child(7) {
            display: none !important;
        }

        /* Make qty and owner controls compact so they don't force large row heights */
        .qty-btn { padding: 3px 6px; min-width: 26px; font-size: 0.8rem; }
        .owner-select, select.owner-select.form-control { font-size: 0.95rem !important; height: 24px !important; line-height:24px !important; }

        /* Ensure the responsive wrapper allows horizontal scroll when narrow */
        #results-card-{{ campaignlist.getId() }} .table-responsive,
        #list-card-{{ campaignlist.getId() }} .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    }

    /* Narrow phones / very small tablets: hide Type as well and make Name take remaining space */
    @media (max-width: 600px) {
        #results-card-{{ campaignlist.getId() }} .table th:nth-child(5),
        #list-card-{{ campaignlist.getId() }} .table th:nth-child(5),
        #results-card-{{ campaignlist.getId() }} .table td:nth-child(5),
        #list-card-{{ campaignlist.getId() }} .table td:nth-child(5) {
            display: none !important;
        }
        /* Make name column more flexible and clamp long pack/type/traits if still present */
        #results-card-{{ campaignlist.getId() }} .table td:nth-child(2) a.card-link,
        #list-card-{{ campaignlist.getId() }} .table td:nth-child(2) a.card-link {
            white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important; max-width: 100%; display: inline-block;
        }
        /* Keep owner and qty controls compact */
        .owner-select, select.owner-select.form-control { width: 110px !important; }
        .qty-btn-group { transform: scale(0.95); }
    }

    /* Mobile: keep compact fonts and allow horizontal scrolling; stacking was intentionally removed */
    @media (max-width: 480px) {
        .campaign-ui a.card-link { font-size: 1.05rem !important; }
        .qty-btn { padding: 2px 6px; min-width: 24px; font-size: 0.78rem; }
        .owner-select, select.owner-select.form-control { font-size: 0.9rem !important; height: 22px !important; line-height:22px !important; }
        #results-card-{{ campaignlist.getId() }} .table td, #list-card-{{ campaignlist.getId() }} .table td { vertical-align: middle; }
    }
</style>

{% set camp = campaignlist.getCampaign() %}
{% if camp is defined and camp %}
{% set camp_def = (campaign_defs[camp.getId()] is defined) ? campaign_defs[camp.getId()] : (campaign_defs|default({})) %}
{# Prefer scenarios stored on the Campaign DB row when available (they are stored as JSON string)
    Decode DB scenarios if present and use them as the source; otherwise fall back to static camp_def.scenarios #}
{# Note: Twig in this environment doesn't provide a json_decode filter. We will
    render the static `camp_def.scenarios` server-side and, if the Campaign row
    contains an updated scenarios JSON string, decode & apply it client-side via JS. #}
{% set scenarios_source = camp_def.scenarios|default({}) %}
{% set cl_vals = (campaignlist_values is defined and campaignlist_values[campaignlist.getId()] is defined) ? campaignlist_values[campaignlist.getId()] : ((campaignlist_values is defined) ? campaignlist_values : {}) %}
{% set ccards = cl_vals.campaign_cards is defined ? cl_vals.campaign_cards : (campaignlist.getCampaignCards() ? campaignlist.getCampaignCards()|raw : null) %}

<div class="campaign-ui">
    <form id="campaign-form-{{ campaignlist.getId() }}" method="post" action="{{ path('team_campaign_edit', {'campaignlist_id': campaignlist.getId() }) }}">
        <input type="hidden" name="_token" value="{{ csrf_token('edit_campaign_' ~ campaignlist.getId()) }}" />

        <div class="ui-card">
            <div class="section-header">Players & Health</div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem;">
                {% set team_decks = campaignlist.getTeam() ? campaignlist.getTeam().getDecks() : [] %}
                {% set players = cl_vals.player_names|default([]) %}
                {% set hp_values = cl_vals.team_hps is defined ? cl_vals.team_hps : (campaignlist.getTeamHps() ? campaignlist.getTeamHps()|raw : []) %}
                
                {% for i in 0..3 %}
                    {% if i < (team_decks|length) %}
                        {% set max_hp = team_decks[i].getCharacter().getHealth()|default(0) %}
                        {% set current_hp = hp_values[i]|default(max_hp) %}
                        <div class="player-slot">
                            <label class="comic-label">Player {{ i+1 }}</label>
                            <input type="text" name="player_names[{{ i }}]" class="form-control mb-2 auto-save comic-input" value="{{ players[i]|default('') }}">
                            
                            <label class="comic-label">Health Point</label>
                            <input type="number" 
                                   name="team_hps[{{ i }}]" 
                                   class="form-control auto-save comic-input hp-monitor {{ (current_hp < max_hp) ? 'hp-damaged' : 'hp-at-max' }}" 
                                   value="{{ current_hp }}"
                                   data-max-hp="{{ max_hp }}"
                                   max="{{ max_hp }}"
                                   min="0">
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <div class="row">
            <div class="col-lg-7">
                <div class="ui-card">
                    <div class="section-header">Campaign Notes</div>
                    {% for n in camp_def.campaign_notes|default([]) %}
                        <div class="mb-3">
                            <label class="font-weight-bold small">{{ n }}</label>
                            <textarea name="campaign_notes[{{ n }}]" class="form-control auto-save" rows="3">{{ cl_vals.campaign_notes[n]|default('') }}</textarea>
                        </div>
                    {% endfor %}
                </div>
            </div>
            {# Right column: show only if we have counters, tracks or checkboxes #}
            {% set has_counters = (camp_def.campaign_counters is defined and camp_def.campaign_counters|length > 0) or (camp.getCampaignCounters() is defined and camp.getCampaignCounters()) or (cl_vals.campaign_counters is defined and cl_vals.campaign_counters|length > 0) %}
            {% set has_tracks = (camp_def.tracks is defined and camp_def.tracks|length > 0) or (camp.getTracks() is defined and camp.getTracks()) %}
            {% set has_checkboxes = (camp_def.campaign_checkbox is defined and camp_def.campaign_checkbox|length > 0) or (camp.getCampaignCheckbox() is defined and camp.getCampaignCheckbox()) %}
            {% if has_counters or has_tracks or has_checkboxes %}
            <div class="col-lg-5">
                <div class="ui-card">
                    {% if has_counters %}
                    <div class="section-header">Counters</div>
                    {% for cname in camp_def.campaign_counters|default([]) %}
                        <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                            <span class="small font-weight-bold text-muted">{{ cname }}</span>
                            <input type="number" name="campaign_counters[{{ cname }}]" class="form-control auto-save" style="width: 80px;" value="{{ cl_vals.campaign_counters[cname]|default(0) }}">
                        </div>
                    {% endfor %}
                    {% endif %}

                    {# Tracks: display static tracks if defined on camp_def else fall back to DB-stored JSON via JS #}
                    {% if camp_def.tracks is defined and camp_def.tracks|length > 0 %}
                        <hr>
                        <div class="section-header">Tracks</div>
                        {% for t in camp_def.tracks %}
                            <div class="mb-3">
                                <div class="small"><strong>{{ t.title|default('') }}</strong></div>
                                <div class="small text-muted" style="white-space:pre-wrap;">{{ t.text|default('')|raw }}</div>
                            </div>
                        {% endfor %}
                    {% elseif camp.getTracks() %}
                        <hr>
                        <div class="section-header">Tracks</div>
                        <div id="tracks-container-{{ campaignlist.getId() }}"></div>
                        <script>
                        (function(){
                            return `
                                <tr>
                                    <td data-label="Quantity" style="width:110px;">${qtyButtons}</td>
                                    <td data-label="Name">
                                        ${factionCircle}
                                        <a href="#" class="card-link card card-tip" data-code="${c.code}" style="font-weight:700; color:#2c3e50;">${c.name}</a>
                                        <div style="font-size:0.75rem; color:#888; margin-left:18px;">${c.code}</div>
                                    </td>
                                    <td data-label="Icons">${iconsCol}</td>
                                    <td data-label="Cost">${cost}</td>
                                    <td data-label="Type">${typeName}</td>
                                    <td data-label="Traits">${traits}</td>
                                    <td data-label="Pack" style="vertical-align:middle; width:140px;">${packName}</td>
                                    <td data-label="Owner">Team</td>
                                </tr>`;
                        })();
                        </script>
                    {% endif %}

                    {% set cb_container_id = 'cb-container-' ~ campaignlist.getId() %}
                    <div id="{{ cb_container_id }}"></div>
                    <script>
                    (function(){
                        try {
                            var defs = null;
                            try {
                                {% if camp_def.campaign_checkbox is defined and camp_def.campaign_checkbox %}
                                    defs = {{ camp_def.campaign_checkbox|json_encode|raw }};
                                {% elseif camp.getCampaignCheckbox() %}
                                    var __defs_raw = {{ camp.getCampaignCheckbox()|json_encode|raw }};
                                    defs = __defs_raw ? JSON.parse(__defs_raw) : null;
                                {% else %}
                                    defs = null;
                                {% endif %}
                            } catch(e) { defs = null; }

                            var saved = null;
                            try {
                                {% if cl_vals.campaign_checkbox is defined %}
                                    saved = {{ cl_vals.campaign_checkbox|json_encode|raw }};
                                {% elseif campaignlist.getCampaignCheckboxes() %}
                                    var __saved_raw = {{ campaignlist.getCampaignCheckboxes()|json_encode|raw }};
                                    saved = __saved_raw ? JSON.parse(__saved_raw) : null;
                                {% else %}
                                    saved = null;
                                {% endif %}
                            } catch(e) { saved = null; }
                            if (!defs || !Array.isArray(defs) || defs.length === 0) return;
                            var container = document.getElementById('{{ cb_container_id }}');
                            if (!container) return;
                            var header = document.createElement('hr');
                            container.appendChild(header);
                            var sect = document.createElement('div'); sect.className = 'section-header'; sect.style.marginTop = '0.5rem'; sect.textContent = 'Checkboxes'; container.appendChild(sect);
                            var list = document.createElement('div'); list.className = 'mb-2';
                            defs.forEach(function(label, idx){
                                var cbWrap = document.createElement('div'); cbWrap.className = 'form-check mb-1';
                                var input = document.createElement('input'); input.type = 'checkbox'; input.className = 'form-check-input';
                                input.name = 'campaign_checkbox[' + label + ']';
                                input.id = 'cb-{{ campaignlist.getId() }}-' + (idx+1);
                                input.value = '1';
                                if (saved && typeof saved === 'object' && saved.hasOwnProperty(label) && !!saved[label]) {
                                    input.checked = true;
                                }
                                var labelEl = document.createElement('label'); labelEl.className = 'form-check-label small'; labelEl.htmlFor = input.id; labelEl.textContent = label;
                                labelEl.style.marginLeft = '8px';
                                input.style.marginRight = '6px';
                                cbWrap.appendChild(input); cbWrap.appendChild(labelEl); list.appendChild(cbWrap);
                            });
                            container.appendChild(list);
                        } catch(e) { /* ignore */ }
                    })();
                    </script>
                </div>
            </div>
            {% endif %}
        </div>

        <input type="hidden" name="selected_scenario" id="scen-input-{{ campaignlist.getId() }}" value="{{ cl_vals.selected_scenario|default(0) }}">
        <div class="scenario-nav-bar">
            <button type="button" id="prev-scen-{{ campaignlist.getId() }}" class="btn btn-sm btn-outline-light px-3">&larr; Previous</button>
            <select id="select-scen-{{ campaignlist.getId() }}" class="scenario-select-custom">
                {% for scode, scenario in (scenarios_source) %}
                    <option value="{{ loop.index0 }}">{{ scenario.name|default(scenario.code|default(scode)) }}</option>
                {% endfor %}
            </select>
            <button type="button" id="next-scen-{{ campaignlist.getId() }}" class="btn btn-sm btn-outline-light px-3">Next &rarr;</button>
        </div>
        <div class="scenario-content">
            {% for scode, scenario in (scenarios_source) %}
                <div class="scenario-block" data-index="{{ loop.index0 }}" style="display:none;">
                    <div style="display:flex; gap:25px; align-items:flex-start; margin-bottom:20px;">
                        {% if scenario.image is defined and scenario.image %}
                            <div style="flex: 0 0 220px; max-width: 220px;">
                                <img src="{{ scenario.image|slice(0,4) == 'http' ? scenario.image : asset('bundles/campaigns/' ~ scenario.image) }}" onerror="this.onerror=null;this.src='https://via.placeholder.com/280x140?text=No+Image';" style="width:100%; border-radius:10px; box-shadow:0 6px 12px rgba(0,0,0,0.1);" alt="Image">
                            </div>
                        {% endif %}
                        <div style="flex:1;">
                            <div class="d-flex align-items-center mb-2">
                                {% set scenario_code = scenario.code is defined ? scenario.code : scode %}
                                <h2 style="margin:0;">{{ scenario.name|default(scenario_code) }}</h2>
                                {# Do not show statistics for interlude scenarios #}
                                {% if not (scenario_code matches('/interlude/i')) %}
                                    <a class="btn btn-sm btn-outline-primary ml-3" href="{{ path('team_campaign_scenario_stats', {'campaignlist_id': campaignlist.getId(), 'scenario_code': scenario_code}) }}">View statistics</a>
                                {% endif %}
                            </div>
                            <p class="text-muted"><em>{{ (scenario.description|default('')|replace({'\\n':'\n'}))|nl2br|raw }}</em></p>
                            <div class="mt-2">
                                {% for m in scenario.modulars|default([]) %}
                                    <span class="badge badge-secondary mr-1" style="font-size: 0.7rem;">{{ m.name|default(m) }}</span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-6 border-right">
                            <h5 class="text-primary font-weight-bold">Setup</h5>
                            <div class="small text-muted" style="white-space:pre-wrap;">{{ (scenario.introduction|default('N/A')|replace({'\\n':'\n'}))|nl2br|raw }}</div>
                        </div>
                        <div class="col-md-6">
                            <h5 class="text-success font-weight-bold">Conclusion</h5>
                            <div class="small text-muted" style="white-space:pre-wrap;">{{ (scenario.resolution|default('N/A')|replace({'\\n':'\n'}))|nl2br|raw }}</div>
                        </div>
                    </div>

                    {% if scenario.epilogue is defined and scenario.epilogue %}
                        <div class="deck-divider-container" style="margin:1rem 0 0.75rem 0;">
                            <div class="deck-divider-line"></div>
                        </div>

                        <h5 class="text-dark font-weight-bold">Epilogue</h5>
                        <p class="text-muted" style="white-space:normal;"><em>{{ (scenario.epilogue|replace({'\\r\\n':'\n','\\n':'\n'}))|raw }}</em></p>
                    {% endif %}

                </div>
            {% endfor %}
        </div>

        <div class="ui-card" style="margin-top:2rem;">
            <div class="section-header">Search & Add Cards</div>
            
            <div id="faction-filters-{{ campaignlist.getId() }}" style="margin-bottom:6px; display:flex; gap:6px; flex-wrap:wrap;"></div>
            <div class="search-wrapper mb-3">
                <input type="text" id="search-card-{{ campaignlist.getId() }}" class="form-control" placeholder="Search cards by name or code...">
                <span id="clear-search-{{ campaignlist.getId() }}" class="search-clear">&times;</span>
            </div>
            
            <div id="results-card-{{ campaignlist.getId() }}" class="row px-3 mb-3" style="max-height: 350px; overflow-y: auto;"></div>
            
            <div class="deck-divider-container">
                <div class="deck-divider-line"></div>
                <div class="deck-divider-badge">
                    <span class="deck-divider-text">Active Campaign Deck</span>
                </div>
            </div>
            
            <div id="list-card-{{ campaignlist.getId() }}" class="row px-3"></div>
            
            <textarea name="campaign_cards" id="json-card-{{ campaignlist.getId() }}" style="display:none !important;">{{ ccards ? (ccards|json_encode) : 'null' }}</textarea>
        </div>

        </form>

        <div class="ui-card" style="margin-top:1rem;">
            <div class="section-header">Epilogue</div>
            <div id="campaign-epilogue-{{ camp.getId() }}" class="text-muted" style="color:#4a4a4a; margin-bottom:0.5rem; text-align:left; white-space:normal;">
                {% if camp.getEpilogue() %}
                    {{ (camp.getEpilogue()|replace({'\\r\\n':'\n','\\n':'\n'}))|raw }}
                {% elseif camp_def.epilogue is defined and camp_def.epilogue %}
                    {{ (camp_def.epilogue|replace({'\\r\\n':'\n','\\n':'\n'}))|raw }}
                {% else %}
                    <em>No epilogue.</em>
                {% endif %}
            </div>
        </div>

        <div class="mt-3" style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
            <div style="text-align:left; color:#666; font-size:0.95rem;">Images for campaign generated with AI.</div>
            <div style="display:inline-flex; gap:8px; align-items:center;">
                <button type="submit" class="btn btn-primary btn-lg px-3 btn-team-action" form="campaign-form-{{ campaignlist.getId() }}"><span class="fa fa-save fa-fw"></span> Save Campaign</button>

                <form method="post" action="{{ path('team_campaign_delete') }}" style="display:inline-block; margin:0;">
                    <input type="hidden" name="campaignlist_id" value="{{ campaignlist.getId() }}" />
                    <input type="hidden" name="_token" value="{{ csrf_token('delete_campaign_' ~ campaignlist.getId()) }}" />
                    <button class="btn btn-danger btn-delete-team btn-team-action" data-toggle="tooltip" title="Delete" type="submit" onclick="return confirm('Are you sure you want to delete this campaign from the team?');"><span class="fa fa-trash-o fa-fw"></span> Delete</button>
                </form>
            </div>
        </div>
    <!-- Buttons fixed at bottom-right; removed dynamic positioning script to ensure visibility -->
</div>

<div id="floating-card-preview">
    <div id="preview-title" style="font-weight:800; color:#2c3e50; border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:10px;"></div>
    <div id="preview-content"></div>
</div>
<div id="auto-save-indicator">Syncing...</div>

<script>
(function() {
    const rId = '{{ campaignlist.getId() }}';
    const players = {{ players|json_encode|raw }};
    const form = document.getElementById('campaign-form-' + rId);
    if (!form) return;

    function checkHP(input) {
        let current = parseInt(input.value) || 0;
        const max = parseInt(input.dataset.maxHp) || 0;
        if (current > max) { current = max; input.value = max; }
        if (current < max) {
            input.classList.add('hp-damaged');
            input.classList.remove('hp-at-max');
        } else {
            input.classList.add('hp-at-max');
            input.classList.remove('hp-damaged');
        }
    }
    form.querySelectorAll('.hp-monitor').forEach(input => {
        input.addEventListener('input', () => checkHP(input));
    });

    const pages = Array.from(form.querySelectorAll('.scenario-block'));
    const sel = form.querySelector('#select-scen-' + rId);
    const inp = form.querySelector('#scen-input-' + rId);
    let cur = parseInt(inp.value) || 0;

    function upd(i) {
        if (i < 0 || i >= pages.length) return;
        pages.forEach((p, idx) => p.style.display = (idx === i) ? 'block' : 'none');
        cur = i; sel.value = i; inp.value = i;
    }
    form.querySelector('#prev-scen-' + rId).onclick = () => upd(cur - 1);
    form.querySelector('#next-scen-' + rId).onclick = () => upd(cur + 1);
    sel.onchange = (e) => upd(parseInt(e.target.value));
    upd(cur);

    const sIn = form.querySelector('#search-card-' + rId);
    const sClear = form.querySelector('#clear-search-' + rId);
    const res = form.querySelector('#results-card-' + rId);
    const list = form.querySelector('#list-card-' + rId);
    const jIn = form.querySelector('#json-card-' + rId);
    let all = null;
    let mine = [];

    try {
        const v = JSON.parse(jIn.value);
        mine = Array.isArray(v) ? v : [];
    } catch(e) { mine = []; }

    // faction filter state (empty = all). Use a Set to allow multi-selection.
    let currentFactions = new Set();

    // render faction buttons container; will be populated after cards fetched
    const factionContainer = form.querySelector('#faction-filters-{{ campaignlist.getId() }}');

    sClear.onclick = () => {
        sIn.value = '';
        sClear.style.display = 'none';
        res.innerHTML = '';
        sIn.focus();
    };

    function draw() {
        // Render the campaign card list as a decklist-style table (qty, thumb+name, icons, cost, type, traits, pack, owner)
        if (!mine || mine.length === 0) {
            list.innerHTML = '<div class="text-muted">No cards in campaign.</div>';
            jIn.value = JSON.stringify(mine);
            attachHoverPreview();
            return;
        }
        const rows = mine.map(c => {
            const def = all ? all.find(x => x.code === c.code) : null;
            const limit = def ? (parseInt(def.deck_limit) || 1) : 1;
            const owner = c.owner || 'Team';
            // build owner select
            let ownerSelect = `<select class="form-control owner-select" data-code="${c.code}" onchange="window.setOwner_${rId}('${c.code}', this.value)" style="width:140px;">`;
            ownerSelect += `<option value="Team"${owner==='Team' ? ' selected' : ''}>Team</option>`;
            players.forEach((p, idx) => {
                const val = 'Player ' + (idx+1);
                const label = (p && String(p).trim().length) ? p : ('Player ' + (idx+1));
                ownerSelect += `<option value="${val}"${owner===val ? ' selected' : ''}>${label}</option>`;
            });
            ownerSelect += `</select>`;

            // Render quantity buttons only up to the card's deck_limit (hide others)
            const qtyArr = [];
            for (let i = 0; i <= limit; i++) {
                const activeCls = (c.qty == i) ? ' active' : '';
                qtyArr.push(`<button type="button" class="qty-btn${activeCls}" onclick="window.modC_${rId}('${c.code}', ${i})">${i}</button>`);
            }
            const qtyButtons = `<div class="qty-btn-group qty-count-${Math.min(limit,4)}">${qtyArr.join('')}</div>`;

            const packName = (def && def.pack_name) ? def.pack_name : (def && def.pack_code ? def.pack_code : '');
            const faction = def ? (def.faction_code || def.faction || '') : (c.faction_code || c.faction || '');
            const factionCircle = faction ? `<span class="fa fa-circle fg-${faction}" title="${faction}" style="display:inline-block;width:10px;height:10px;line-height:10px;margin-right:8px;"></span>` : '';

            const displayName = def && def.name ? def.name : (c.name || '');

            return `
                <tr>
                    <td data-label="Quantity" style="vertical-align:middle; width:110px;">${qtyButtons}</td>
                    <td data-label="Name" style="vertical-align:middle; min-width:260px;">
                        ${factionCircle}
                        <a href="${def ? def.url : '#'}" class="card-link card card-tip" data-code="${c.code}" style="font-weight:700; color:#2c3e50;">${displayName}</a>
                        <div style="font-size:0.75rem; color:#888; margin-left:18px;">${c.code}</div>
                    </td>
                    <td data-label="Icons" style="vertical-align:middle; width:80px;">${def && def.icons ? def.icons : ''}</td>
                    <td data-label="Cost" style="vertical-align:middle; width:60px;">${def && (def.cost!==undefined) ? def.cost : ''}</td>
                    <td data-label="Type" style="vertical-align:middle; width:100px;">${def && def.type_name ? def.type_name : (def && def.type ? def.type : '')}</td>
                    <td data-label="Traits" style="vertical-align:middle;">${def && def.traits ? def.traits : ''}</td>
                    <td data-label="Pack" style="vertical-align:middle; width:140px;">${packName}</td>
                    <td data-label="Owner" style="vertical-align:middle; width:160px;">${ownerSelect}</td>
                </tr>`;
        }).join('');

        list.innerHTML = `<div class="table-responsive"><table class="table table-sm table-hover" style="margin-bottom:0;"><thead><tr><th style="width:110px;">Quantity</th><th>Name</th><th>Icons</th><th>Cost</th><th>Type</th><th>Traits</th><th>Pack</th><th>Owner</th></tr></thead><tbody>${rows}</tbody></table></div>`;
        jIn.value = JSON.stringify(mine);
        attachHoverPreview();
    }

    window['modC_' + rId] = (code, qty, name) => {
        const hit = mine.find(x => x.code === code);
        if (qty === 0) {
            if (hit) mine = mine.filter(x => x.code !== code);
        } else {
            if (hit) hit.qty = qty;
            else mine.push({ code, name: name || code, qty: qty, owner: 'Team' });
        }
        draw();
        if (sIn.value.length >= 2) performFilter(sIn.value);
        auto();
    };

    // owner setter used by the owner select in the drawn list
    window['setOwner_' + rId] = function(code, owner) {
        const hit = mine.find(x => x.code === code);
        if (!hit) return;
        hit.owner = owner;
        jIn.value = JSON.stringify(mine);
        auto();
        draw();
    };

    sIn.oninput = (e) => {
        const q = e.target.value.toLowerCase();
        sClear.style.display = q.length > 0 ? 'block' : 'none';
        if (q.length < 2) { res.innerHTML = ''; return; }
        if (!all) {
            try {
                if (window.app && app.data && Array.isArray(app.data.cards) && app.data.cards.length) {
                    all = app.data.cards;
                    console.log('DEBUG: using app.data.cards (sample 5):', all.slice(0,5));
                    buildFactionButtons();
                    performFilter(q);
                    draw();
                    return;
                }
            } catch(e) { /* ignore access errors */ }
            fetch('/api/public/cards/').then(r => r.json()).then(data => {
                all = data;
                console.log('DEBUG: fetched /api/public/cards/ (sample 5):', Array.isArray(all) ? all.slice(0,5) : all);
                buildFactionButtons();
                performFilter(q);
                draw();
            });
        } else performFilter(q);
    };

    // After fetching all cards, populate faction buttons
    function buildFactionButtons() {
        if (!all || !factionContainer) return;
        let factions = Array.from(new Set(all.map(c => c.faction_code).filter(Boolean))).sort();
        // fallback to a sensible set if API doesn't provide faction_code values
        if (!factions || factions.length === 0) {
            factions = ['hero','villain','encounter','campaign','basic','support'];
        }
        console.log('DEBUG: derived factions:', factions);
        // add a small debug indicator for quick visual verification
        try {
            var dbg = document.getElementById('faction-debug-{{ campaignlist.getId() }}');
            if (!dbg) {
                dbg = document.createElement('div'); dbg.id = 'faction-debug-{{ campaignlist.getId() }}'; dbg.style.fontSize = '0.75rem'; dbg.style.color = '#666'; dbg.style.marginBottom = '6px'; factionContainer.parentNode.insertBefore(dbg, factionContainer.nextSibling);
            }
            dbg.textContent = 'Factions: ' + factions.join(', ');
        } catch(e) { /* ignore debug rendering errors */ }
        // always include 'all' first
        factionContainer.innerHTML = '';
        const btnAll = document.createElement('button');
        btnAll.type = 'button';
        btnAll.className = 'btn btn-sm btn-outline-secondary';
        btnAll.textContent = 'All';
        btnAll.dataset.faction = '';
        if (currentFactions.size === 0) btnAll.classList.add('active');
        btnAll.onclick = () => { currentFactions.clear(); updateFactionButtons(); if (sIn.value.length>=2) performFilter(sIn.value.toLowerCase()); };
        factionContainer.appendChild(btnAll);
        factions.forEach(f => {
            const b = document.createElement('button');
            b.type = 'button';
            b.className = 'btn btn-sm btn-outline-secondary';
            b.textContent = (f.charAt(0).toUpperCase() + f.slice(1));
            b.dataset.faction = f;
            b.onclick = () => {
                if (currentFactions.has(f)) currentFactions.delete(f); else currentFactions.add(f);
                updateFactionButtons();
                if (sIn.value.length>=2) performFilter(sIn.value.toLowerCase());
            };
            factionContainer.appendChild(b);
        });
        function updateFactionButtons(){
            Array.from(factionContainer.querySelectorAll('button')).forEach(b => {
                const df = (b.dataset.faction || '');
                if (df === '' && currentFactions.size === 0) b.classList.add('active');
                else if (df !== '' && currentFactions.has(df)) b.classList.add('active');
                else b.classList.remove('active');
            });
            // update debug display if present
            try {
                var dbg = document.getElementById('faction-debug-{{ campaignlist.getId() }}');
                if (dbg) {
                    const arr = Array.from(currentFactions);
                    dbg.textContent = 'Factions: ' + (arr.length ? arr.join(', ') : 'All');
                }
            } catch(e) { /* ignore */ }
        }
    }

    function performFilter(q) {
        if (!q) return;
        // base filter by name/code
        let hits = all.filter(c => (c.name && c.name.toLowerCase().indexOf(q) !== -1) || (c.code && c.code.toLowerCase().indexOf(q) !== -1));
        // apply faction filter if any selected (multi-select)
        if (currentFactions && currentFactions.size > 0) {
            hits = hits.filter(c => currentFactions.has((c.faction_code || '')));
        }
        // deduplicate by duplicate-group: prefer parent (duplicate_of_code) if present
        const seen = new Set();
        const unique = [];
        for (let i = 0; i < hits.length; i++) {
            const c = hits[i];
            if (!c || !c.code) continue;
            // determine group key: if this card points to a parent via duplicate_of_code, use that as key
            const groupKey = (c.duplicate_of_code || c.duplicate_of || '') || c.code;
            // if we have a parent code, try to find the parent card object to display instead
            let representative = c;
            if (groupKey && groupKey !== c.code) {
                const parent = all.find(x => x.code === groupKey);
                if (parent) representative = parent;
            }
            const repKey = representative.code || groupKey;
            if (seen.has(repKey)) continue;
            seen.add(repKey);
            unique.push(representative);
            if (unique.length >= 20) break;
        }
        hits = unique;
        // build results: render a table like the campaign list so layout is consistent
        if (!hits || hits.length === 0) {
            res.innerHTML = '<div class="text-muted">No results.</div>';
            attachHoverPreview();
            return;
        }
        const rows = hits.map(c => {
            const current = mine.find(x => x.code === c.code);
            const curQty = current ? current.qty : 0;
            const limit = parseInt(c.deck_limit) || 1;
            const faction = c.faction_code || c.faction || '';
            // faction circle before name (use same fa-circle + fg-<faction> markup used elsewhere)
            const factionCircle = faction ? `<span class="fa fa-circle fg-${faction}" title="${faction}" style="display:inline-block;width:10px;height:10px;line-height:10px;margin-right:8px;"></span>` : '';
            // icons column should show card resource icons (if present)
            const iconsCol = c.icons || '';
            const qtyArr = [];
            for (let i = 0; i <= limit; i++) {
                const activeCls = (curQty == i) ? ' active' : '';
                qtyArr.push(`<button type="button" class="qty-btn${activeCls}" onclick="window.modC_${rId}('${c.code}', ${i})">${i}</button>`);
            }
            const qtyButtons = `<div class="qty-btn-group">${qtyArr.join('')}</div>`;
            const packName = (c.pack_name) ? c.pack_name : (c.pack_code ? c.pack_code : '');
            const cost = (c.cost !== undefined && c.cost !== null) ? c.cost : '';
            const typeName = c.type_name || '';
            const traits = c.traits || '';
            return `
                <tr>
                    <td style="width:110px;">${qtyButtons}</td>
                    <td>
                        ${factionCircle}
                        <a href="#" class="card-link card card-tip" data-code="${c.code}" style="font-weight:700; color:#2c3e50;">${c.name}</a>
                        <div style="font-size:0.75rem; color:#888; margin-left:18px;">${c.code}</div>
                    </td>
                    <td>${iconsCol}</td>
                    <td>${cost}</td>
                    <td>${typeName}</td>
                    <td>${traits}</td>
                    <td style="vertical-align:middle; width:140px;">${packName}</td>
                    <td>Team</td>
                </tr>`;
        }).join('');
        res.innerHTML = `<div class="table-responsive"><table class="table table-sm table-hover" style="margin-bottom:0;"><thead><tr><th style="width:110px;">Quantity</th><th>Name</th><th>Icons</th><th>Cost</th><th>Type</th><th>Traits</th><th>Pack</th><th>Owner</th></tr></thead><tbody>${rows}</tbody></table></div>`;
        attachHoverPreview();
    }

    function attachHoverPreview() {
        const preview = document.getElementById('floating-card-preview');
        const pTitle = document.getElementById('preview-title');
        const pContent = document.getElementById('preview-content');
        // attach to existing .card-link elements (backwards compatible)
        form.querySelectorAll('.card-link').forEach(link => {
            // allow preview for all .card-link elements (including ones with card-tip)
            link.onmouseenter = function(e) {
                const code = this.getAttribute('data-code');
                const c = all ? all.find(x => x.code === code) : null;
                pTitle.textContent = c ? c.name : code;
                let html = "";
                if (c && c.text) html += `<div style="font-size:0.8rem; line-height:1.4; color:#444; white-space:pre-wrap; margin-bottom:12px;">${c.text}</div>`;
                html += `<img src="/bundles/cards/${code}.jpg" style="width:100%; border-radius:6px; margin-bottom:12px;" onerror="this.onerror=null; this.src='/bundles/cards/missing.jpg';">`;
                if (c && c.pack_name) html += `<div style="font-size:0.75rem; color:#888;">${c.pack_name}</div>`;
                pContent.innerHTML = html;
                preview.style.display = 'block';
            };
            link.onmousemove = function(e) {
                preview.style.left = (e.clientX + 20) + 'px';
                preview.style.top = (e.clientY - 150) + 'px';
            };
            link.onmouseleave = function() { preview.style.display = 'none'; };
        });

        // Event delegation: ensure hover works for dynamically replaced/added links
        if (!form._previewDelegated) {
            form._previewDelegated = true;
            // attach to document as well to cover elements rendered outside the form
            if (!window._previewDelegated) {
                window._previewDelegated = true;
                document.addEventListener('mouseover', function(e) {
                        const el = e.target.closest && e.target.closest('.card-link');
                        if (!el) return;
                    const code = el.getAttribute('data-code');
                    const c = all ? all.find(x => x.code === code) : null;
                    pTitle.textContent = c ? c.name : code;
                    let html = "";
                    if (c && c.text) html += `<div style="font-size:0.8rem; line-height:1.4; color:#444; white-space:pre-wrap; margin-bottom:12px;">${c.text}</div>`;
                    html += `<img src="/bundles/cards/${code}.jpg" style="width:100%; border-radius:6px; margin-bottom:12px;" onerror="this.onerror=null; this.src='/bundles/cards/missing.jpg';">`;
                    if (c && c.pack_name) html += `<div style="font-size:0.75rem; color:#888;">${c.pack_name}</div>`;
                    pContent.innerHTML = html;
                    preview.style.display = 'block';
                });
                document.addEventListener('mousemove', function(e) {
                    const el = e.target.closest && e.target.closest('.card-link');
                    if (el) {
                        preview.style.left = (e.clientX + 20) + 'px';
                        preview.style.top = (e.clientY - 150) + 'px';
                    }
                });
                document.addEventListener('mouseout', function(e) {
                    const related = e.relatedTarget;
                    if (!related || !related.closest || !related.closest('.card-link')) {
                        preview.style.display = 'none';
                    }
                });
            }
        }
    }

    (function initAll(){
        try {
            if (window.app && app.data && Array.isArray(app.data.cards) && app.data.cards.length) {
                all = app.data.cards;
                console.log('DEBUG: init using app.data.cards (sample 5):', all.slice(0,5));
                if (typeof buildFactionButtons === 'function') buildFactionButtons();
                draw();
                return;
            }
        } catch(e) { /* ignore */ }
        fetch('/api/public/cards/').then(r => r.json()).then(data => { all = data; console.log('DEBUG: fetched /api/public/cards/ (sample 5):', Array.isArray(all) ? all.slice(0,5) : all); if (typeof buildFactionButtons === 'function') buildFactionButtons(); draw(); });
    })();

    let t;
    const stat = document.getElementById('auto-save-indicator');
    function auto() {
        clearTimeout(t);
        t = setTimeout(() => {
            if(stat) { stat.style.display = 'block'; stat.textContent = 'Saving...'; }
            fetch(form.action, { method: 'POST', body: new FormData(form), headers: {'X-Requested-With': 'XMLHttpRequest'} })
            .then(() => { if(stat) { stat.textContent = 'Saved ✓'; setTimeout(() => stat.style.display='none', 1500); } });
        }, 1500);
    }
    form.querySelectorAll('.auto-save, textarea').forEach(i => i.addEventListener('input', auto));
})();
</script>
{% endif %}

{% if camp.getScenarios() is defined and camp.getScenarios() %}
<script>
document.addEventListener('DOMContentLoaded', function(){
    try {
        var dbRaw = {{ camp.getScenarios()|json_encode|raw }};
        var dbScenarios = dbRaw ? JSON.parse(dbRaw) : null;
        if (!dbScenarios || !Array.isArray(dbScenarios)) return;

        // Find scenario blocks for this campaignlist and replace content
        var blocks = document.querySelectorAll('#campaign-form-{{ campaignlist.getId() }} .scenario-block');
        blocks.forEach(function(block, idx){
            var s = dbScenarios[idx];
            if (!s) return;
            var scenario_code = s.code || block.getAttribute('data-index') || idx;
            // title
            var h2 = block.querySelector('h2');
            if (h2) h2.textContent = s.name || scenario_code;
            // image
            if (s.image) {
                var img = block.querySelector('img');
                if (img) {
                    img.onerror = function(){ this.onerror=null; this.src='https://via.placeholder.com/280x140?text=No+Image'; };
                    img.src = (s.image.slice && s.image.slice(0,4) == 'http') ? s.image : ('/bundles/campaigns/' + s.image);
                }
            }
            // description (allow HTML from JSON, preserve newlines)
            var p = block.querySelector('p.text-muted em');
            if (p) {
                var desc = s.description || '';
                desc = desc.replace(/\r\n/g, '\n');
                desc = desc.replace(/\\n/g, '\n');
                p.innerHTML = desc.replace(/\n/g, '<br/>');
            }
            // modulars badges
            var mcont = block.querySelector('div.mt-2');
            if (mcont) {
                var mods = s.modulars || [];
                if (Array.isArray(mods) && mods.length) {
                    mcont.innerHTML = mods.map(function(m){ var name = (m && m.name) ? m.name : (typeof m === 'string' ? m : ''); return '<span class="badge badge-secondary mr-1" style="font-size: 0.7rem;">' + name + '</span>'; }).join('');
                }
            }
            // introduction & resolution: these are the two .small.text-muted elements
            var smalls = block.querySelectorAll('.small.text-muted');
            if (smalls && smalls.length) {
                var intro = s.introduction || '';
                var resol = s.resolution || '';
                intro = intro.replace(/\r\n/g, '\n');
                intro = intro.replace(/\\n/g, '\n');
                resol = resol.replace(/\r\n/g, '\n');
                resol = resol.replace(/\\n/g, '\n');
                if (smalls[0]) smalls[0].innerHTML = intro.replace(/\n/g, '<br/>');
                if (smalls[1]) smalls[1].innerHTML = resol.replace(/\n/g, '<br/>');
                // epilogue element (if present)
                var epiEl = block.querySelector('.scenario-epilogue em');
                if (epiEl) {
                    var epi = s.epilogue || '';
                    epi = epi.replace(/\r\n/g, '\n'); epi = epi.replace(/\\n/g, '\n');
                    epiEl.innerHTML = epi.replace(/\n/g, '<br/>');
                }
            }
        });
    } catch(e) { console && console.warn && console.warn('Applying DB scenarios failed', e); }
});
</script>
{% endif %}
